# SPDX-License-Identifier: MIT
# Copyright (c) 2025 OmniNode Team
#
# ONEX FSM Contract: Dual Registration Reducer
#
# This contract defines the finite state machine for the dual registration
# workflow that handles node introspection events and coordinates parallel
# registration to Consul and PostgreSQL backends.
#
# Related: OMN-889 - Infrastructure MVP: ModelNodeIntrospectionEvent
#
# =============================================================================
# STATE MACHINE OVERVIEW
# =============================================================================
#
# The dual registration reducer processes NODE_INTROSPECTION events and
# orchestrates registration to multiple backends (Consul for service discovery,
# PostgreSQL for persistent node registry).
#
# Flow:
#   1. Receive introspection event from Kafka
#   2. Validate payload structure (node_id, node_type required)
#   3. Dispatch parallel registration to Consul + PostgreSQL
#   4. Aggregate results from both backends
#   5. Emit final result (success, partial, or failure)
#
# =============================================================================
contract_version: "1.0.0"
name: "dual_registration_reducer_fsm"
description: "FSM contract for dual registration reducer handling node introspection events"
# =============================================================================
# STATE MACHINE DEFINITION
# =============================================================================
state_transitions:
  state_machine_name: dual_registration_fsm
  initial_state: idle
  persistence_enabled: true
  # ---------------------------------------------------------------------------
  # STATES
  # ---------------------------------------------------------------------------
  states:
    # -------------------------------------------------------------------------
    # IDLE - Waiting for introspection events
    # -------------------------------------------------------------------------
    - state_name: idle
      description: "Initial state - waiting for node introspection events"
      is_terminal: false
      entry_actions:
        - action: reset_registration_context
          description: "Clear any previous registration state"
      exit_actions:
        - action: log_state_transition
          description: "Log transition from idle state"
    # -------------------------------------------------------------------------
    # RECEIVING_INTROSPECTION - Received NODE_INTROSPECTION event
    # -------------------------------------------------------------------------
    - state_name: receiving_introspection
      description: "Received NODE_INTROSPECTION event, parsing payload"
      is_terminal: false
      entry_actions:
        - action: extract_event_payload
          description: "Extract introspection data from Kafka event"
        - action: capture_correlation_id
          description: "Capture correlation_id for distributed tracing"
      exit_actions:
        - action: log_event_received
          description: "Log received event details"
    # -------------------------------------------------------------------------
    # VALIDATING_PAYLOAD - Validating introspection data structure
    # -------------------------------------------------------------------------
    - state_name: validating_payload
      description: "Validating introspection payload structure and required fields"
      is_terminal: false
      entry_actions:
        - action: validate_required_fields
          description: "Validate node_id, node_type, and other required fields"
        - action: validate_payload_schema
          description: "Validate payload against ModelNodeIntrospectionEvent schema"
      exit_actions:
        - action: emit_validation_result
          description: "Emit validation success or failure"
    # -------------------------------------------------------------------------
    # REGISTERING_PARALLEL - Parallel registration to Consul + PostgreSQL
    # -------------------------------------------------------------------------
    - state_name: registering_parallel
      description: "Dispatching parallel registration to Consul and PostgreSQL"
      is_terminal: false
      entry_actions:
        - action: dispatch_consul_registration
          description: "Send registration request to Consul adapter"
        - action: dispatch_postgres_registration
          description: "Send registration request to PostgreSQL adapter"
        - action: start_registration_timeout
          description: "Start timeout timer for registration attempts"
      exit_actions:
        - action: cancel_registration_timeout
          description: "Cancel timeout timer when all registrations complete"
    # -------------------------------------------------------------------------
    # AGGREGATING_RESULTS - Combining registration results
    # -------------------------------------------------------------------------
    - state_name: aggregating_results
      description: "Aggregating results from Consul and PostgreSQL registrations"
      is_terminal: false
      entry_actions:
        - action: collect_registration_results
          description: "Collect success/failure status from both backends"
        - action: calculate_success_count
          description: "Calculate number of successful registrations"
      exit_actions:
        - action: prepare_final_result
          description: "Prepare final registration result payload"
    # -------------------------------------------------------------------------
    # REGISTRATION_COMPLETE - Both backends succeeded (terminal)
    # -------------------------------------------------------------------------
    - state_name: registration_complete
      description: "Both Consul and PostgreSQL registration succeeded"
      is_terminal: true
      entry_actions:
        - action: emit_success_event
          description: "Emit NODE_REGISTERED event with full success"
        - action: log_registration_success
          description: "Log successful dual registration"
        - action: update_metrics_success
          description: "Increment success metrics counter"
      exit_actions:
        - action: cleanup_registration_context
          description: "Clean up temporary registration state"
    # -------------------------------------------------------------------------
    # PARTIAL_FAILURE - One backend failed, graceful degradation (terminal)
    # -------------------------------------------------------------------------
    - state_name: partial_failure
      description: "One backend failed, operating in degraded mode"
      is_terminal: true
      entry_actions:
        - action: emit_partial_success_event
          description: "Emit NODE_REGISTERED event with partial success flag"
        - action: log_partial_failure
          description: "Log which backend failed and which succeeded"
        - action: update_metrics_partial
          description: "Increment partial failure metrics counter"
        - action: schedule_retry_for_failed_backend
          description: "Schedule retry for the failed backend registration"
      exit_actions:
        - action: cleanup_registration_context
          description: "Clean up temporary registration state"
    # -------------------------------------------------------------------------
    # REGISTRATION_FAILED - Both backends failed (error terminal)
    # -------------------------------------------------------------------------
    - state_name: registration_failed
      description: "Both backends failed or validation failed"
      is_terminal: true
      entry_actions:
        - action: emit_failure_event
          description: "Emit NODE_REGISTRATION_FAILED event"
        - action: log_registration_failure
          description: "Log failure details with error context"
        - action: update_metrics_failure
          description: "Increment failure metrics counter"
        - action: capture_debug_intelligence
          description: "Capture failure context for debug intelligence"
      exit_actions:
        - action: cleanup_registration_context
          description: "Clean up temporary registration state"
  # ---------------------------------------------------------------------------
  # TRANSITIONS
  # ---------------------------------------------------------------------------
  transitions:
    # -------------------------------------------------------------------------
    # idle -> receiving_introspection
    # -------------------------------------------------------------------------
    - from: idle
      to: receiving_introspection
      trigger: introspection_event_received
      description: "Triggered when NODE_INTROSPECTION event received from Kafka"
      actions:
        - action: initialize_registration_context
          description: "Initialize context for this registration attempt"
    # -------------------------------------------------------------------------
    # receiving_introspection -> validating_payload
    # -------------------------------------------------------------------------
    - from: receiving_introspection
      to: validating_payload
      trigger: event_parsed
      description: "Event payload successfully extracted and parsed"
      actions:
        - action: store_parsed_payload
          description: "Store parsed introspection data in context"
    # -------------------------------------------------------------------------
    # validating_payload -> registering_parallel (validation passed)
    # -------------------------------------------------------------------------
    - from: validating_payload
      to: registering_parallel
      trigger: validation_passed
      description: "Payload validation succeeded, proceed to registration"
      conditions:
        - expression: "node_id exists true"
          description: "node_id field must be present"
        - expression: "node_type exists true"
          description: "node_type field must be present"
      actions:
        - action: prepare_registration_requests
          description: "Prepare registration payloads for both backends"
    # -------------------------------------------------------------------------
    # validating_payload -> registration_failed (validation failed)
    # -------------------------------------------------------------------------
    - from: validating_payload
      to: registration_failed
      trigger: validation_failed
      description: "Payload validation failed due to missing or invalid fields"
      actions:
        - action: capture_validation_errors
          description: "Capture validation error details"
    # -------------------------------------------------------------------------
    # registering_parallel -> aggregating_results
    # -------------------------------------------------------------------------
    - from: registering_parallel
      to: aggregating_results
      trigger: registration_attempts_complete
      description: "Both registration attempts have completed (success or failure)"
      actions:
        - action: gather_backend_responses
          description: "Gather responses from Consul and PostgreSQL"
    # -------------------------------------------------------------------------
    # aggregating_results -> registration_complete (all succeeded)
    # -------------------------------------------------------------------------
    - from: aggregating_results
      to: registration_complete
      trigger: all_backends_succeeded
      description: "Both Consul and PostgreSQL registrations succeeded"
      conditions:
        - expression: "consul_registered equals true"
          description: "Consul registration must have succeeded"
        - expression: "postgres_registered equals true"
          description: "PostgreSQL registration must have succeeded"
      actions:
        - action: merge_registration_results
          description: "Merge results from both backends"
    # -------------------------------------------------------------------------
    # aggregating_results -> partial_failure (partial success)
    # -------------------------------------------------------------------------
    - from: aggregating_results
      to: partial_failure
      trigger: partial_success
      description: "One backend succeeded, one failed - graceful degradation"
      conditions:
        - expression: "success_count greater_than 0"
          description: "At least one backend must have succeeded"
      actions:
        - action: identify_failed_backend
          description: "Identify which backend failed for retry"
        - action: record_successful_backend
          description: "Record which backend succeeded"
    # -------------------------------------------------------------------------
    # aggregating_results -> registration_failed (all failed)
    # -------------------------------------------------------------------------
    - from: aggregating_results
      to: registration_failed
      trigger: all_backends_failed
      description: "Both Consul and PostgreSQL registrations failed"
      actions:
        - action: aggregate_failure_reasons
          description: "Aggregate failure reasons from both backends"
    # -------------------------------------------------------------------------
    # registration_complete -> idle (result emitted)
    # -------------------------------------------------------------------------
    - from: registration_complete
      to: idle
      trigger: result_emitted
      description: "Success result emitted, ready for next event"
      actions:
        - action: reset_for_next_event
          description: "Reset reducer state for next introspection event"
    # -------------------------------------------------------------------------
    # partial_failure -> idle (partial result emitted)
    # -------------------------------------------------------------------------
    - from: partial_failure
      to: idle
      trigger: partial_result_emitted
      description: "Partial success result emitted, ready for next event"
      actions:
        - action: reset_for_next_event
          description: "Reset reducer state for next introspection event"
    # -------------------------------------------------------------------------
    # registration_failed -> idle (failure result emitted)
    # -------------------------------------------------------------------------
    - from: registration_failed
      to: idle
      trigger: failure_result_emitted
      description: "Failure result emitted, ready for next event"
      actions:
        - action: reset_for_next_event
          description: "Reset reducer state for next introspection event"
# =============================================================================
# CONTEXT VARIABLES
# =============================================================================
# These variables are maintained in the FSM context during execution
context_variables:
  - name: correlation_id
    type: uuid
    description: "Distributed tracing correlation ID from incoming event"
  - name: node_id
    type: uuid
    description: "Node identifier from introspection event (UUID format)"
  - name: node_type
    type: string
    # Valid values: EFFECT, COMPUTE, REDUCER, ORCHESTRATOR (Literal type in Pydantic model)
    description: "Node archetype type - one of: EFFECT, COMPUTE, REDUCER, ORCHESTRATOR"
  - name: introspection_payload
    type: object
    description: "Full parsed introspection event payload"
  - name: consul_registered
    type: boolean
    description: "Whether Consul registration succeeded"
  - name: postgres_registered
    type: boolean
    description: "Whether PostgreSQL registration succeeded"
  - name: success_count
    type: integer
    description: "Number of successful backend registrations (0, 1, or 2)"
  - name: consul_error
    type: object
    description: "Error details if Consul registration failed"
  - name: postgres_error
    type: object
    description: "Error details if PostgreSQL registration failed"
  - name: registration_start_time
    type: timestamp
    description: "Timestamp when registration started"
# =============================================================================
# ERROR HANDLING
# =============================================================================
error_handling:
  default_error_state: registration_failed
  timeout_seconds: 30
  retry_policy:
    max_retries: 3
    # Valid backoff_type values: exponential, linear, constant
    backoff_type: exponential
    initial_delay_ms: 1000
    max_delay_ms: 30000
# =============================================================================
# METRICS
# =============================================================================
metrics:
  counters:
    - name: dual_registration_success_total
      description: "Total successful dual registrations"
    - name: dual_registration_partial_total
      description: "Total partial registration successes"
    - name: dual_registration_failure_total
      description: "Total registration failures"
  histograms:
    - name: dual_registration_duration_seconds
      description: "Duration of dual registration workflow"
      buckets: [0.1, 0.25, 0.5, 1.0, 2.5, 5.0, 10.0]
