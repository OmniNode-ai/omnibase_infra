# shared_key_registry.yaml
#
# Authoritative list of keys shared across all OmniNode repos.
# Keys come from ~/.omnibase/.env (shell env) at dev time,
# and from Infisical /shared/<transport>/ at runtime.
#
# Semantics:
#   shared            — eligible for Infisical seeding + repo .env stripping;
#                       loaded by _load_registry() in scripts/register-repo.py.
#                       A shared key represents the canonical platform-wide value.
#                       Some shared keys (e.g. POSTGRES_DSN) may also be seeded
#                       per-service under /services/<repo>/ via REPO_SECRET_KEYS
#                       in register-repo.py — those per-service entries are
#                       intentional overrides that take precedence at runtime.
#   bootstrap_only    — excluded from Infisical seeding (circular bootstrap dep);
#                       listed here for awareness only; must never be in any repo
#                       .env; loaded by _bootstrap_keys() in register-repo.py
#   identity_defaults — never in any .env; hardcoded as default= in Settings
#                       classes; loaded by _identity_defaults() in
#                       register-repo.py
#
# Used by:
#   - ~/.omnibase/scripts/onboard-repo.py  (strip shared keys from repo .env)
#   - scripts/register-repo.py seed-shared  (seed /shared/* in Infisical)
#
# version: increment minor when adding keys, major on breaking structural changes.
version: "1.0"
# Keys written to /shared/<transport>/ in Infisical.
shared:
  "/shared/db/":
    - POSTGRES_HOST
    - POSTGRES_PORT
    - POSTGRES_USER
    # per-service override also seeded via REPO_SECRET_KEYS (see header)
    - POSTGRES_DSN
    - POSTGRES_POOL_MIN_SIZE
    - POSTGRES_POOL_MAX_SIZE
    - POSTGRES_TIMEOUT_MS
    - QUERY_TIMEOUT_SECONDS # ConfigSessionStorage.query_timeout_seconds (not in transport_config_map)
  "/shared/kafka/":
    # KAFKA_HOST_SERVERS intentionally excluded — removed as dead code (see commit 45f6ae65)
    - KAFKA_GROUP_ID
    - KAFKA_ACKS
    - KAFKA_REQUEST_TIMEOUT_MS
  "/shared/consul/":
    - CONSUL_HOST
    - CONSUL_PORT
    - CONSUL_SCHEME
    - CONSUL_ACL_TOKEN
    - CONSUL_ENABLED
  # NOTE: No VAULT transport type in EnumInfraTransportType yet — VAULT_ADDR is seeded
  # but cannot be prefetched via ConfigPrefetcher until VAULT is added to the enum.
  "/shared/vault/":
    # NOTE: VAULT_TOKEN intentionally excluded — it is per-service and must be
    # provisioned per repo under /services/<repo>/vault/VAULT_TOKEN, not shared
    # platform-wide. Sharing a single token would grant every service the same
    # Vault policy, violating least-privilege. Each service gets its own token
    # scoped to its required paths.
    - VAULT_ADDR
  "/shared/llm/":
    - REMOTE_SERVER_IP
    - LLM_CODER_URL
    - LLM_CODER_FAST_URL
    - LLM_EMBEDDING_URL
    - LLM_DEEPSEEK_R1_URL
    - EMBEDDING_MODEL_URL
    - VLLM_SERVICE_URL
    - VLLM_DEEPSEEK_URL
    - VLLM_LLAMA_URL
    - ONEX_TREE_SERVICE_URL
    - METADATA_STAMPING_SERVICE_URL
  "/shared/auth/":
    - OPENAI_API_KEY
    - GOOGLE_API_KEY
    - GEMINI_API_KEY
    - Z_AI_API_KEY
    - Z_AI_API_URL
    - SERVICE_AUTH_TOKEN
    - GH_PAT
  "/shared/valkey/":
    - VALKEY_HOST
    - VALKEY_PORT
    - VALKEY_PASSWORD
    - VALKEY_DB
  "/shared/qdrant/":
    - QDRANT_HOST
    - QDRANT_PORT
    - QDRANT_API_KEY
  "/shared/env/":
    - SLACK_WEBHOOK_URL
    - SLACK_BOT_TOKEN
    - SLACK_CHANNEL_ID
# Keys that must NEVER be seeded into Infisical.
# These live OUTSIDE repos (home dir or deployment secrets) and must never
# appear in any repo .env file. Two distinct reasons apply — see subcategories:
#
# [circular-startup-dep] These keys are required BY Infisical (or its upstream
# dependencies) during container boot. Storing them in Infisical would create a
# chicken-and-egg deadlock: Infisical needs Postgres/Kafka to start, so those
# credentials must be available BEFORE Infisical is reachable. Lives in
# ~/.omnibase/.env (dev) or an external secrets manager (prod).
#
# [infisical-internal] These are Infisical's own service secrets — the credentials
# that the Infisical container itself uses for internal encryption and auth.
# Storing them inside Infisical would be circular at a different level: if Infisical
# lost or rotated these, it could no longer decrypt its own data. Lives in
# ~/.omnibase/.env (dev) or deployment secrets (prod). Never in any repo.
bootstrap_only:
  # [circular-startup-dep] Postgres password — Infisical depends on Postgres to start;
  # this must exist before Infisical is reachable.
  - POSTGRES_PASSWORD
  # [circular-startup-dep] Kafka bootstrap address — containers need this BEFORE
  # Infisical is reachable. Moved from shared/kafka to bootstrap_only (OMN-2287).
  # If upgrading from a prior Infisical seed: delete the stale
  # /shared/kafka/KAFKA_BOOTSTRAP_SERVERS entry from Infisical manually
  # (one-time cleanup; tracked in docs/plans/2026-02-21-zero-repo-env-files.md).
  - KAFKA_BOOTSTRAP_SERVERS
  # [circular-startup-dep] Infisical connection details — needed to reach Infisical
  # itself; cannot be fetched from Infisical.
  - INFISICAL_ADDR
  - INFISICAL_CLIENT_ID
  - INFISICAL_CLIENT_SECRET
  - INFISICAL_PROJECT_ID
  # [infisical-internal] Infisical's own service secrets — used for internal data
  # encryption and authentication. Rotating or losing these would prevent Infisical
  # from decrypting its own stored secrets. Must live outside Infisical entirely.
  - INFISICAL_ENCRYPTION_KEY
  - INFISICAL_AUTH_SECRET
# Keys that are per-repo identity config.
# Must NEVER appear in any .env file — hardcoded as default= in Settings classes.
identity_defaults:
  - POSTGRES_DATABASE
