# shared_key_registry.yaml
#
# Authoritative list of keys shared across all OmniNode repos.
# Keys come from ~/.omnibase/.env (shell env) at dev time,
# and from Infisical /shared/<transport>/ at runtime.
#
# Semantics:
#   shared            — eligible for Infisical seeding + repo .env stripping;
#                       loaded by _load_registry() in scripts/register-repo.py.
#                       A shared key represents the canonical platform-wide value.
#                       Keys may also be seeded per-service under /services/<repo>/
#                       via REPO_SECRET_KEYS — those per-service entries are
#                       intentional overrides that take precedence at runtime.
#   bootstrap_only    — excluded from Infisical seeding (circular bootstrap dep);
#                       listed here for awareness only; must never be in any repo
#                       .env; loaded by _bootstrap_keys() in register-repo.py
#   identity_defaults — never in any .env; hardcoded as default= in Settings
#                       classes; loaded by _identity_defaults() in
#                       register-repo.py
#
# Used by:
#   - ~/.omnibase/scripts/onboard-repo.py  (strip shared keys from repo .env)
#   - scripts/register-repo.py seed-shared  (seed /shared/* in Infisical)
#
# version: increment minor when adding keys, major on breaking structural changes.
version: "1.0"
# Keys written to /shared/<transport>/ in Infisical.
shared:
  "/shared/db/":
    - POSTGRES_HOST
    - POSTGRES_PORT
    - POSTGRES_USER
    # POSTGRES_DSN intentionally removed — a shared DSN with a hardcoded
    # database name silently routes all services to the wrong database.
    # Each repo sets POSTGRES_DATABASE and builds its own connection string.
    - POSTGRES_POOL_MIN_SIZE
    - POSTGRES_POOL_MAX_SIZE
    - POSTGRES_TIMEOUT_MS
    # Shared default; override per-service at /services/<repo>/db/
    - QUERY_TIMEOUT_SECONDS
  "/shared/kafka/":
    # KAFKA_HOST_SERVERS intentionally excluded — removed as dead code (see commit 45f6ae65)
    #
    # WARNING: PLACEHOLDER ONLY — DO NOT USE IN PRODUCTION.
    # KAFKA_GROUP_ID is seeded to /shared/kafka/ solely as a platform-wide placeholder.
    # Each service MUST override this at /services/<repo>/kafka/KAFKA_GROUP_ID via onboard-repo
    # before the service starts. Shared consumer groups cause unintended load-balancing across
    # topics — relying on this shared value in production is a misconfiguration.
    #
    # Policy: missing per-service override is an advisory warning (not a hard error) to avoid
    # blocking onboard-repo when the override has already been set via other means (e.g. manual
    # Infisical UI). A hard error would be a false positive in that case and would prevent valid
    # onboarding runs from completing. The warning is sufficient to alert operators who have
    # not yet set the override.
    - KAFKA_GROUP_ID
    - KAFKA_ACKS
    - KAFKA_REQUEST_TIMEOUT_MS
  "/shared/consul/":
    - CONSUL_HOST
    - CONSUL_PORT
    - CONSUL_SCHEME
    - CONSUL_ACL_TOKEN
    - CONSUL_ENABLED
  # NOTE: No VAULT transport type in EnumInfraTransportType yet — VAULT_ADDR is seeded
  # but cannot be prefetched via ConfigPrefetcher until VAULT is added to the enum.
  # TODO: add VAULT to EnumInfraTransportType and transport_config_map.py to enable ConfigPrefetcher support
  # NOT prefetched by ConfigPrefetcher — no EnumInfraTransportType.VAULT entry; keys resolved via shell env fallback.
  "/shared/vault/":
    # NOTE: VAULT_TOKEN intentionally excluded — it is per-service and must be
    # provisioned per repo under /services/<repo>/vault/VAULT_TOKEN, not shared
    # platform-wide. Sharing a single token would grant every service the same
    # Vault policy, violating least-privilege. Each service gets its own token
    # scoped to its required paths.
    - VAULT_ADDR
  "/shared/llm/":
    # IP of the remote GPU/inference server (used to construct LLM endpoint URLs).
    - REMOTE_SERVER_IP
    # Canonical LLM endpoint keys (defined in CLAUDE.md LLM topology):
    #   LLM_CODER_URL        — Qwen3-Coder-30B-A3B AWQ-4bit (RTX 5090, 64K ctx, port 8000)
    #   LLM_CODER_FAST_URL   — Qwen3-14B-AWQ (RTX 4090, 40K ctx, port 8001)
    #   LLM_EMBEDDING_URL    — Qwen3-Embedding-8B-4bit (M2 Ultra, port 8100)
    #   LLM_DEEPSEEK_R1_URL  — DeepSeek-R1-Distill-Qwen-32B-bf16 (M2 Ultra, port 8101)
    - LLM_CODER_URL
    - LLM_CODER_FAST_URL
    - LLM_EMBEDDING_URL
    - LLM_DEEPSEEK_R1_URL
    # ONEX platform service URLs (not LLM models — kept here as they are co-located
    # on the same inference infrastructure and share the REMOTE_SERVER_IP base).
    - ONEX_TREE_SERVICE_URL
    - METADATA_STAMPING_SERVICE_URL
  # NOT prefetched by ConfigPrefetcher — no EnumInfraTransportType.AUTH entry; keys resolved via shell env fallback.
  "/shared/auth/":
    - OPENAI_API_KEY
    - GOOGLE_API_KEY
    - GEMINI_API_KEY
    - Z_AI_API_KEY
    - Z_AI_API_URL
    - SERVICE_AUTH_TOKEN
    - GH_PAT
  "/shared/valkey/":
    - VALKEY_HOST
    - VALKEY_PORT
    - VALKEY_PASSWORD
    - VALKEY_DB
  "/shared/qdrant/":
    - QDRANT_HOST
    - QDRANT_PORT
    - QDRANT_API_KEY
    - QDRANT_URL
  # NOT prefetched by ConfigPrefetcher — no EnumInfraTransportType.ENV entry; keys resolved via shell env fallback.
  "/shared/env/":
    - SLACK_WEBHOOK_URL
    - SLACK_BOT_TOKEN
    - SLACK_CHANNEL_ID
# Keys that must NEVER be seeded into Infisical.
# These live OUTSIDE repos (home dir or deployment secrets) and must never
# appear in any repo .env file. Two distinct reasons apply — see subcategories:
#
# [circular-startup-dep] These keys are required BY Infisical (or its upstream
# dependencies) during container boot. Storing them in Infisical would create a
# chicken-and-egg deadlock: Infisical needs Postgres/Kafka to start, so those
# credentials must be available BEFORE Infisical is reachable. Lives in
# ~/.omnibase/.env (dev) or an external secrets manager (prod).
#
# [infisical-internal] These are Infisical's own service secrets — the credentials
# that the Infisical container itself uses for internal encryption and auth.
# Storing them inside Infisical would be circular at a different level: if Infisical
# lost or rotated these, it could no longer decrypt its own data. Lives in
# ~/.omnibase/.env (dev) or deployment secrets (prod). Never in any repo.
bootstrap_only:
  # [circular-startup-dep] Postgres password — Infisical depends on Postgres to start;
  # this must exist before Infisical is reachable.
  - POSTGRES_PASSWORD
  # [circular-startup-dep] Kafka bootstrap address — containers need this BEFORE
  # Infisical is reachable. Moved from shared/kafka to bootstrap_only (OMN-2287).
  # If upgrading from a prior Infisical seed: delete the stale
  # /shared/kafka/KAFKA_BOOTSTRAP_SERVERS entry from Infisical manually
  # (one-time cleanup; tracked in docs/plans/2026-02-21-zero-repo-env-files.md).
  # Infisical path to delete if migrating to bootstrap-only: /shared/kafka/KAFKA_BOOTSTRAP_SERVERS
  - KAFKA_BOOTSTRAP_SERVERS
  # [circular-startup-dep] Infisical connection details — needed to reach Infisical
  # itself; cannot be fetched from Infisical.
  - INFISICAL_ADDR
  - INFISICAL_CLIENT_ID
  - INFISICAL_CLIENT_SECRET
  - INFISICAL_PROJECT_ID
  # [infisical-internal] Infisical's own service secrets — used for internal data
  # encryption and authentication. Rotating or losing these would prevent Infisical
  # from decrypting its own stored secrets. Must live outside Infisical entirely.
  - INFISICAL_ENCRYPTION_KEY
  - INFISICAL_AUTH_SECRET
# Keys that are per-repo identity config.
# Must NEVER appear in any .env file — hardcoded as default= in Settings classes.
identity_defaults:
  - POSTGRES_DATABASE
# Keys that exist in /shared/ as platform-wide defaults but MUST be overridden
# per-service under /services/<repo>/<transport>/<KEY> before the service starts.
# Relying on the shared value in production is a misconfiguration.
# register-repo.py onboard-repo will warn if any of these are absent from the plan.
service_override_required:
  # Each service must set its own consumer group ID to avoid unintended
  # load-balancing across topics when multiple services share a group.
  - KAFKA_GROUP_ID
