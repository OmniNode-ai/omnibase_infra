# Security-enhanced Docker Compose configuration for OmniNode Bridge
version: '3.8'

networks:
  omninode-bridge-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: omninode-bridge0
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  postgres_data:
    driver: local
  postgres_ssl_certs:
    driver: local
  redpanda_data:
    driver: local
  consul_data:
    driver: local
  consul_config:
    driver: local

services:
  # PostgreSQL with SSL/TLS support
  postgres:
    image: postgres:15-alpine
    container_name: omninode-bridge-postgres
    networks:
      omninode-bridge-network:
        ipv4_address: 172.20.0.10
    secrets:
      - postgres_password
      - postgres_ssl_cert
      - postgres_ssl_key
      - postgres_ssl_ca
    environment:
      POSTGRES_DB: omninode_bridge
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      # SSL Configuration
      POSTGRES_INITDB_ARGS: "--auth-host=md5 --auth-local=peer"
    ports:
      - "127.0.0.1:5436:5432"  # Bind only to localhost
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_ssl_certs:/var/lib/postgresql/ssl
      - ./ssl/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./ssl/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
      -c hba_file=/etc/postgresql/pg_hba.conf
      -c ssl=on
      -c ssl_cert_file=/run/secrets/postgres_ssl_cert
      -c ssl_key_file=/run/secrets/postgres_ssl_key
      -c ssl_ca_file=/run/secrets/postgres_ssl_ca
      -c ssl_ciphers='ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256'
      -c ssl_min_protocol_version='TLSv1.2'
      -c ssl_max_protocol_version='TLSv1.3'
      -c log_connections=on
      -c log_disconnections=on
      -c log_statement=ddl
      -c shared_preload_libraries='pg_stat_statements'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d omninode_bridge"]
      interval: 10s
      timeout: 5s
      retries: 5
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    restart: unless-stopped

  # RedPanda with enhanced security
  redpanda:
    image: redpandadata/redpanda:v24.2.7
    container_name: omninode-bridge-redpanda
    networks:
      omninode-bridge-network:
        ipv4_address: 172.20.0.20
    ports:
      - "127.0.0.1:9092:9092"      # Internal Kafka API
      - "127.0.0.1:29092:29092"    # External Kafka API
      - "127.0.0.1:9644:9644"      # Admin API
      - "127.0.0.1:8082:8082"      # HTTP Proxy API
    command:
      - redpanda
      - start
      - --kafka-addr=internal://0.0.0.0:9092,external://0.0.0.0:29092
      - --advertise-kafka-addr=internal://omninode-bridge-redpanda:9092,external://localhost:29092
      - --pandaproxy-addr=internal://0.0.0.0:8082,external://0.0.0.0:8083
      - --advertise-pandaproxy-addr=internal://omninode-bridge-redpanda:8082,external://localhost:8083
      - --schema-registry-addr=internal://0.0.0.0:8081,external://0.0.0.0:8084
      - --rpc-addr=omninode-bridge-redpanda:33145
      - --advertise-rpc-addr=omninode-bridge-redpanda:33145
      - --mode=dev-container
      - --smp=1
      - --default-log-level=info
      - --enable-sasl
    environment:
      REDPANDA_AUTO_CREATE_TOPICS_ENABLED: false  # Disable auto-creation for security
      REDPANDA_DEFAULT_TOPIC_PARTITIONS: 3
      REDPANDA_DEFAULT_TOPIC_REPLICATIONS: 1
      REDPANDA_TOPIC_CLEANUP_POLICY: delete
      REDPANDA_LOG_RETENTION_MS: 604800000  # 7 days
      REDPANDA_SEGMENT_MS: 3600000           # 1 hour
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD", "rpk", "cluster", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    user: "101:101"  # redpanda user
    restart: unless-stopped

  # Consul with security enhancements
  consul:
    image: hashicorp/consul:1.17
    container_name: omninode-bridge-consul
    networks:
      omninode-bridge-network:
        ipv4_address: 172.20.0.30
    ports:
      - "127.0.0.1:8500:8500"     # HTTP API
      - "127.0.0.1:8600:8600/udp" # DNS
    environment:
      CONSUL_BIND_INTERFACE: eth0
      CONSUL_CLIENT_INTERFACE: eth0
      CONSUL_DISABLE_PPROF: true
    command: >
      consul agent
      -server
      -bootstrap-expect=1
      -datacenter=omninode-bridge
      -data-dir=/consul/data
      -config-dir=/consul/config
      -ui
      -client=0.0.0.0
      -bind=0.0.0.0
      -log-level=INFO
      -disable-host-node-id
      -encrypt=$(consul keygen)
    volumes:
      - consul_data:/consul/data:Z
      - consul_config:/consul/config:Z
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 5s
      retries: 5
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp:noexec,nosuid,size=50m
    restart: unless-stopped

  # Enhanced HookReceiver Service
  hook-receiver:
    build:
      context: .
      dockerfile: Dockerfile.hook-receiver.secure
    container_name: omninode-bridge-hook-receiver
    networks:
      omninode-bridge-network:
        ipv4_address: 172.20.0.40
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    ports:
      - "127.0.0.1:8001:8001"  # Bind only to localhost
    environment:
      # Service configuration
      HOOK_RECEIVER_HOST: 0.0.0.0
      HOOK_RECEIVER_PORT: 8001
      LOG_LEVEL: info

      # Kafka configuration
      KAFKA_BOOTSTRAP_SERVERS: omninode-bridge-redpanda:9092

      # PostgreSQL SSL configuration
      POSTGRES_HOST: omninode-bridge-postgres
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: omninode_bridge
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set in environment}
      POSTGRES_SSL_ENABLED: true
      POSTGRES_SSL_CERT: /app/ssl/client.crt
      POSTGRES_SSL_KEY: /app/ssl/client.key
      POSTGRES_SSL_CA: /app/ssl/ca.crt
      POSTGRES_SSL_CHECK_HOSTNAME: false  # For development

      # Security settings
      API_KEY: ${API_KEY}
      CORS_ALLOWED_ORIGINS: http://localhost:3000,http://localhost:8000

      # Application metadata
      ENVIRONMENT: production
      SERVICE_VERSION: 0.1.0
    volumes:
      - ./src:/app/src:ro
      - ./logs:/app/logs
      - ./ssl/client:/app/ssl:ro
    secrets:
      - postgres_ssl_cert
      - postgres_ssl_key
      - postgres_ssl_ca
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /app/tmp:noexec,nosuid,size=50m
    restart: unless-stopped

secrets:
  postgres_password:
    environment: "POSTGRES_PASSWORD"
  postgres_ssl_cert:
    file: ./ssl/postgres/server.crt
  postgres_ssl_key:
    file: ./ssl/postgres/server.key
  postgres_ssl_ca:
    file: ./ssl/ca/ca.crt
  api_key:
    environment: "API_KEY"

# Security profiles for production deployment
profiles:
  security:
    postgres:
      deploy:
        resources:
          limits:
            memory: 512M
            cpus: '0.5'
        restart_policy:
          condition: unless-stopped
          delay: 5s
          max_attempts: 3
    hook-receiver:
      deploy:
        resources:
          limits:
            memory: 256M
            cpus: '0.3'
        restart_policy:
          condition: unless-stopped
          delay: 5s
          max_attempts: 3
