# OmniNode Bridge Database Migrations

This directory contains Alembic database migration scripts for the OmniNode Bridge application.

## Overview

Alembic is a database migration tool for SQLAlchemy. It provides a way to manage database schema changes over time through versioned migration scripts.

## Usage

### Environment Setup

Database connection is configured automatically based on environment variables:

- `OMNINODE_BRIDGE_DATABASE_URL` - Full database URL (highest priority)
- `DATABASE_URL` - Alternative database URL
- Individual environment variables:
  - `POSTGRES_HOST` (default: localhost)
  - `POSTGRES_PORT` (default: 5436)
  - `POSTGRES_USER` (default: postgres)
  - `POSTGRES_PASSWORD` (default: your_password)
  - `POSTGRES_DATABASE` (default: omninode_bridge)

### Common Commands

#### Create a new migration
```bash
alembic revision --autogenerate -m "Description of changes"
```

#### Apply migrations
```bash
alembic upgrade head
```

#### Downgrade one revision
```bash
alembic downgrade -1
```

#### Show migration history
```bash
alembic history --verbose
```

#### Show current revision
```bash
alembic current
```

#### Validate migration scripts
```bash
alembic check
```

### Migration Best Practices

1. **Always review autogenerated migrations** - Alembic may not detect all changes correctly
2. **Test migrations on a copy of production data** before applying to production
3. **Create backup** before running migrations in production
4. **Use descriptive commit messages** for migration revisions
5. **Add data migrations** when schema changes require data transformation

### Production Deployment

1. **Backup database** before migration
2. **Run in maintenance mode** if schema changes affect running application
3. **Test rollback procedure** on staging environment
4. **Monitor application** after migration completion

### Troubleshooting

#### Common Issues

1. **Import errors** - Ensure all model imports are available in env.py
2. **Connection issues** - Verify database URL and connectivity
3. **Migration conflicts** - Resolve using `alembic merge` command
4. **Schema drift** - Use `alembic check` to detect inconsistencies

#### Emergency Rollback

If a migration causes issues:

1. **Stop application** to prevent data corruption
2. **Restore database backup** if data integrity is compromised
3. **Downgrade using Alembic** if schema-only changes
4. **Review and fix migration** before re-applying

### Security Considerations

- Database credentials are managed through environment variables
- Migration scripts are version controlled but should not contain sensitive data
- Production migrations should be reviewed and approved before execution
- Access to migration commands should be restricted in production environments
