repos:
  # Fast file checks that can run in parallel
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: trailing-whitespace
        exclude: '\.github/workflows(?:-generated)?/.*\.ya?ml$|k8s/.*\.ya?ml$|monitoring/.*\.ya?ml$'
      - id: end-of-file-fixer
        exclude: '\.github/workflows(?:-generated)?/.*\.ya?ml$|k8s/.*\.ya?ml$|monitoring/.*\.ya?ml$'
      - id: check-yaml
        exclude: 'k8s/.*\.ya?ml$|\.github/workflows/.*\.ya?ml$|\.github/workflows-generated/.*\.yml$|monitoring/.*\.yml$'
      - id: check-added-large-files
      - id: check-merge-conflict
      - id: check-toml

  # Fast Python formatting and linting (optimized for speed)
  - repo: local
    hooks:
      - id: black-format
        name: black (auto-format)
        entry: poetry run black
        language: system
        types: [python]
        args: [--line-length, "88", --target-version, py312]
        exclude: '\.github/workflows/.*|^\.[^/]*$|^\..*/.*'
        stages: [commit]

      - id: isort-format
        name: isort (auto-sort imports)
        entry: poetry run isort
        language: system
        types: [python]
        args: [--profile, black, --line-length, "88"]
        exclude: '\.github/workflows/.*|^\.[^/]*$|^\..*/.*'
        stages: [commit]

      - id: ruff-fix
        name: ruff (auto-fix linting issues)
        entry: poetry run ruff check --fix
        language: system
        types: [python]
        exclude: '\.github/workflows/.*|^\.[^/]*$|^\..*/.*'
        stages: [commit]

      # O.N.E. v0.1 metadata validation
      - id: validate-one-metadata
        name: Validate O.N.E. v0.1 Metadata Headers
        entry: poetry run python scripts/validate_metadata.py --all --strict
        language: system
        files: '^src/omninode_bridge/services/metadata_stamping/.*\.py$'
        pass_filenames: false
        always_run: false
        stages: [commit]
        description: 'Validate O.N.E. v0.1 metadata headers in MetadataStampingService files'

      # Backwards compatibility validation (DISABLED - no external consumers yet)
      # Detects breaking changes in public APIs, function signatures, Pydantic models, and type annotations
      # Compares staged changes against main branch baseline
      # - id: backwards-compatibility
      #   name: Backwards compatibility validation
      #   entry: poetry run python scripts/validate_backwards_compatibility.py --staged
      #   language: system
      #   types: [python]
      #   pass_filenames: false
      #   stages: [commit]
      #   description: 'Validate backwards compatibility of API changes against main branch'

      # Selective testing for pre-commit (quick feedback)
      - id: selective-tests-commit
        name: Selective tests (quick feedback)
        entry: poetry run python scripts/selective_test_runner.py --staged --quick
        language: system
        files: '^src/'
        require_serial: true
        stages: [commit]

  # Secrets detection (parallel capable)
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        args: ["--baseline", ".secrets.baseline"]
        exclude: "tests/|examples/|\\.lock$"
        stages: [commit]

  # Pre-push hooks for comprehensive testing and automation
  - repo: local
    hooks:
      # Automatic stamping and OnexTree ingestion
      - id: stamp-and-ingest
        name: Stamp changed files and ingest to OnexTree (pre-push)
        entry: poetry run python scripts/stamp_and_ingest.py
        language: system
        stages: [push]
        pass_filenames: false
        verbose: true
        description: 'Automatically stamp changed files with BLAKE3 hashes and ingest patterns to OnexTree. Supports all file types (Python, docs, configs, etc.)'

      - id: comprehensive-tests
        name: Comprehensive tests (pre-push)
        entry: poetry run python scripts/selective_test_runner.py --push --timeout=300
        language: system
        stages: [push]
        require_serial: true
        verbose: true

      - id: security-scan
        name: Security scan (pre-push)
        entry: poetry run bandit -r src/ -f json -o bandit-report.json
        language: system
        stages: [push]
        pass_filenames: false
