# Deployment Manifest for NodeDistributedLockEffect
deployment:
  # Container Configuration
  container:
    image: omninode-bridge/distributed-lock-effect:1.0.0
    dockerfile: deployment/docker/Dockerfile.distributed_lock_effect
    build_context: .
    platform: linux/amd64

  # Environment Variables
  environment:
    # Service Configuration
    SERVICE_NAME: distributed-lock-effect
    SERVICE_PORT: "8062"
    SERVICE_VERSION: "1.0.0"
    LOG_LEVEL: "${LOG_LEVEL:-info}"

    # PostgreSQL Configuration
    POSTGRES_HOST: "${POSTGRES_HOST:-192.168.86.200}"
    POSTGRES_PORT: "${POSTGRES_PORT:-5436}"
    POSTGRES_DATABASE: "${POSTGRES_DATABASE:-omninode_bridge}"
    POSTGRES_USER: "${POSTGRES_USER}"
    POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    POSTGRES_MIN_CONNECTIONS: "5"
    POSTGRES_MAX_CONNECTIONS: "20"

    # Lock Configuration
    DEFAULT_LEASE_DURATION: "30.0"
    CLEANUP_INTERVAL: "60.0"
    MAX_ACQUIRE_ATTEMPTS: "3"

    # Consul Configuration
    CONSUL_HOST: "${CONSUL_HOST:-192.168.86.200}"
    CONSUL_PORT: "${CONSUL_PORT:-28500}"
    CONSUL_SERVICE_ID: "distributed-lock-effect-${HOSTNAME}"

    # Kafka Configuration
    KAFKA_BOOTSTRAP_SERVERS: "${KAFKA_BOOTSTRAP_SERVERS:-192.168.86.200:9092}"
    KAFKA_TOPIC_LOCK_ACQUIRED: "dev.omninode-bridge.lock.acquired.v1"
    KAFKA_TOPIC_LOCK_RELEASED: "dev.omninode-bridge.lock.released.v1"
    KAFKA_TOPIC_LOCK_EXPIRED: "dev.omninode-bridge.lock.expired.v1"

    # Metrics Configuration
    METRICS_ENABLED: "true"
    METRICS_PORT: "9090"

  # Port Mappings
  ports:
    - host: 8062
      container: 8062
      protocol: tcp
      description: HTTP API

    - host: 9090
      container: 9090
      protocol: tcp
      description: Prometheus metrics

  # Volume Mounts
  volumes:
    - host: ./logs/distributed_lock
      container: /app/logs
      mode: rw

    - host: /var/run/docker.sock
      container: /var/run/docker.sock
      mode: ro

  # Resource Limits
  resources:
    limits:
      cpu: "1.0"
      memory: "512M"
      pids: 100

    reservations:
      cpu: "0.2"
      memory: "256M"

  # Health Check
  health_check:
    test: ["CMD", "curl", "-f", "http://localhost:8062/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 30s

  # Restart Policy
  restart_policy: unless-stopped

  # Dependencies
  depends_on:
    consul:
      condition: service_healthy
    postgres:
      condition: service_healthy
    redpanda:
      condition: service_started

  # Network Configuration
  networks:
    - omninode-bridge-network

  # Labels
  labels:
    com.omninode.node_type: effect
    com.omninode.service_name: distributed-lock-effect
    com.omninode.version: "1.0.0"
    com.omninode.environment: "${ENVIRONMENT:-development}"

# Kubernetes Configuration (optional)
kubernetes:
  deployment:
    replicas: 3
    strategy:
      type: RollingUpdate
      rolling_update:
        max_surge: 1
        max_unavailable: 0

    pod_template:
      labels:
        app: distributed-lock-effect
        version: v1
        node_type: effect

      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"

  service:
    type: ClusterIP
    ports:
      - name: http
        port: 8062
        target_port: 8062
      - name: metrics
        port: 9090
        target_port: 9090

  ingress:
    enabled: false

  autoscaling:
    enabled: true
    min_replicas: 2
    max_replicas: 10
    target_cpu_utilization: 70
    target_memory_utilization: 80
