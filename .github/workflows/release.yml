# SPDX-FileCopyrightText: 2025 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT
name: Release

on:
  push:
    tags: ['v[0-9]*.[0-9]*.[0-9]*']
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag to release (e.g. v0.10.0)'
        required: true

permissions:
  contents: write

concurrency:
  group: release-${{ github.repository }}-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}

      - name: Assert clean working tree
        run: |
          git diff --exit-code
          git diff --cached --exit-code
          test -z "$(git ls-files --others --exclude-standard)"

      - name: Validate tag matches pyproject.toml version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi
          TAG="${TAG#v}"
          PKG_VERSION=$(python3 -c "
          import tomllib, sys
          with open('pyproject.toml', 'rb') as f:
              d = tomllib.load(f)
          v = d.get('project', {}).get('version')
          if not v:
              raise SystemExit('ERROR: missing [project].version in pyproject.toml')
          print(v)
          ")
          if [ "$TAG" != "$PKG_VERSION" ]; then
            echo "ERROR: tag v${TAG} does not match pyproject.toml version $PKG_VERSION"
            exit 1
          fi
          echo "Version validated: $PKG_VERSION"

      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.12'

      - name: Build wheel + sdist
        run: uv build

      - name: Verify dist artifacts exist
        run: |
          ls -la dist/
          ls dist/*.whl dist/*.tar.gz >/dev/null 2>&1 || {
            echo "ERROR: expected wheel + sdist in dist/"
            exit 1
          }

      - name: Publish to PyPI
        run: |
          uv publish --token "$UV_PUBLISH_TOKEN" dist/*.whl dist/*.tar.gz
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}

      - name: Generate checksums
        run: sha256sum dist/*.whl dist/*.tar.gz > dist/SHA256SUMS.txt

      - name: Set release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          files: |
            dist/*.whl
            dist/*.tar.gz
            dist/SHA256SUMS.txt
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, 'rc') }}

  # ---------------------------------------------------------------------------
  # Post-release: trigger runtime Docker image rebuild (OMN-2751)
  # ---------------------------------------------------------------------------
  # When omnibase_infra is released, the runtime image in omninode_infra must be
  # rebuilt to pick up the new version. This uses repository_dispatch to trigger
  # the build-and-push workflow in the omninode_infra repo.
  #
  # REQUIREMENT: The CROSS_REPO_PAT repository secret must be set to a GitHub
  # Personal Access Token (classic) with `repo` scope on all OmniNode-ai repos,
  # or a fine-grained PAT with Contents: read+write on OmniNode-ai/omninode_infra.
  # The built-in GITHUB_TOKEN cannot dispatch to external repositories.
  # If CROSS_REPO_PAT is absent the dispatch step is skipped with a warning so
  # that the release itself is not marked as failed.
  trigger-runtime-rebuild:
    name: Trigger Runtime Image Rebuild
    needs: release
    if: ${{ !contains(needs.release.outputs.version, 'rc') }}
    runs-on: ubuntu-latest
    steps:
      - name: Check CROSS_REPO_PAT is configured
        id: token_check
        env:
          CROSS_REPO_PAT: ${{ secrets.CROSS_REPO_PAT }}
        run: |
          if [ -z "$CROSS_REPO_PAT" ]; then
            echo "::warning::CROSS_REPO_PAT secret is not set. Skipping cross-repo dispatch." \
              "Set a PAT with 'repo' scope (or fine-grained Contents write on OmniNode-ai/omninode_infra)" \
              "as the CROSS_REPO_PAT repository secret to enable runtime image rebuild triggers."
            echo "has_token=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_token=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Dispatch runtime rebuild to omninode_infra
        if: steps.token_check.outputs.has_token == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.CROSS_REPO_PAT }}
          repository: OmniNode-ai/omninode_infra
          event-type: foundation-release
          client-payload: >-
            {
              "package": "omnibase_infra",
              "version": "${{ needs.release.outputs.version }}",
              "source_repo": "${{ github.repository }}",
              "source_sha": "${{ github.sha }}"
            }

  # ---------------------------------------------------------------------------
  # Post-release: open dependency bump PRs in downstream repos (OMN-2751)
  # ---------------------------------------------------------------------------
  dependency-cascade:
    name: Dependency Cascade
    needs: release
    if: ${{ !contains(needs.release.outputs.version, 'rc') }}
    uses: ./.github/workflows/dependency-cascade.yml
    with:
      package: omnibase_infra
      version: ${{ needs.release.outputs.version }}
    secrets:
      cross-repo-pat: ${{ secrets.CROSS_REPO_PAT }}
