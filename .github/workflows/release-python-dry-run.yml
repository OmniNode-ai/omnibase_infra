# SPDX-FileCopyrightText: 2026 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT
name: Release Dry Run (manual)

on:
  workflow_dispatch:
    inputs:
      package-name:
        description: "Package name for display only"
        required: true
        type: string
      simulated-tag:
        description: "Simulated version tag (e.g. v0.2.0)"
        required: true
        type: string

jobs:
  dry-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.5.x"

      - name: Set up Python
        run: uv python install 3.12

      - name: Extract version
        id: version
        run: |
          TAG="${{ inputs['simulated-tag'] }}"
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Validate pyproject.toml version matches simulated tag
        run: |
          PYPROJECT_VERSION=$(python3 -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              d = tomllib.load(f)
          v = d.get('project', {}).get('version')
          if not v:
              raise SystemExit('ERROR: missing [project].version in pyproject.toml — PEP 621 migration required before releasing')
          print(v)
          ")
          TAG_VERSION="${{ steps.version.outputs.version }}"
          if [ "$PYPROJECT_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: pyproject.toml version ($PYPROJECT_VERSION) does not match simulated tag ($TAG_VERSION)"
            exit 1
          fi
          echo "Version validated: $PYPROJECT_VERSION"

      - name: Build wheel and sdist
        run: uv build

      - name: Verify dist artifacts
        run: |
          ls -la dist/
          ls dist/*.whl dist/*.tar.gz >/dev/null 2>&1 || {
            echo "ERROR: expected wheel + sdist in dist/ — build may have failed silently"
            exit 1
          }

      - name: Generate SHA256SUMS
        run: |
          cd dist
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: DRY RUN complete — skipping publish
        run: |
          echo "DRY RUN: Would publish ${{ inputs['package-name'] }} ${{ steps.version.outputs.tag }} to PyPI"
          echo "Artifacts ready:"
          ls -lh dist/
