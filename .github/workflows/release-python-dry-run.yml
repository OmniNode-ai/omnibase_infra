# SPDX-FileCopyrightText: 2026 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT
name: Release Dry Run (manual)

on:
  workflow_dispatch:
    inputs:
      package-name:
        description: "Package name for display only"
        required: true
        type: string
      simulated-tag:
        description: "Simulated version tag (e.g. v0.2.0)"
        required: true
        type: string

jobs:
  dry-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.5.27"

      - name: Set up Python
        run: uv python install 3.12

      - name: Extract version
        id: version
        env:
          SIMULATED_TAG: ${{ inputs['simulated-tag'] }}
        run: |
          TAG="${SIMULATED_TAG}"
          if [[ ! "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: simulated-tag must be in vX.Y.Z format, got: ${TAG}"
            exit 1
          fi
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Validate pyproject.toml version matches simulated tag
        env:
          TAG_VERSION: ${{ steps.version.outputs.version }}
        run: |
          set -euo pipefail
          if [ ! -f "pyproject.toml" ]; then
            echo "ERROR: pyproject.toml not found at checkout root"
            exit 1
          fi
          PYPROJECT_VERSION=$(uv run python3 -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              d = tomllib.load(f)
          v = d.get('project', {}).get('version')
          if not v:
              raise SystemExit('ERROR: missing [project].version in pyproject.toml — PEP 621 migration required before releasing')
          print(v)
          ")
          if [ "$PYPROJECT_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: pyproject.toml version ($PYPROJECT_VERSION) does not match simulated tag ($TAG_VERSION)"
            exit 1
          fi
          echo "Version validated: $PYPROJECT_VERSION"

      - name: Build wheel and sdist
        run: uv build

      - name: Validate package metadata (twine check)
        run: uv run --with twine twine check dist/*

      - name: Verify dist artifacts
        run: |
          if ! ls dist/*.whl 1>/dev/null 2>&1; then
            echo "ERROR: No .whl artifact found in dist/"
            ls dist/ || true
            exit 1
          fi
          if ! ls dist/*.tar.gz 1>/dev/null 2>&1; then
            echo "ERROR: No .tar.gz artifact found in dist/"
            ls dist/ || true
            exit 1
          fi
          echo "Artifacts:"
          ls -lh dist/

      - name: Generate SHA256SUMS
        run: |
          cd dist
          sha256sum *.whl *.tar.gz > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ steps.version.outputs.tag }}
          path: dist/
          retention-days: 7

      - name: DRY RUN complete — skipping publish
        env:
          PACKAGE_NAME: ${{ inputs['package-name'] }}
          RELEASE_TAG: ${{ steps.version.outputs.tag }}
        run: |
          echo "DRY RUN: Would publish ${PACKAGE_NAME} ${RELEASE_TAG} to PyPI"
          echo "Artifacts ready:"
          ls -lh dist/
