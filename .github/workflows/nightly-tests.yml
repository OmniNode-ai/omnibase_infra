# Nightly test suite for slow and chaos tests
# These tests are too slow for regular CI but essential for resilience validation
#
# Runs:
# - Daily at 2:00 AM UTC
# - On manual workflow dispatch
#
# Test categories included:
# - @pytest.mark.slow: Performance tests (>1s runtime)
# - @pytest.mark.chaos: Chaos engineering tests (fault injection, resilience)
# - @pytest.mark.replay: Event replay and recovery tests
#
# Related: OMN-955 (Chaos and replay testing)

name: Nightly Tests

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test marker filter (e.g., "slow", "chaos", "slow or chaos")'
        required: false
        default: 'slow or chaos'

env:
  POETRY_VERSION: "2.2.1"
  PYTHON_VERSION: "3.12"
  CACHE_VERSION: "0.4.0"

jobs:
  slow-tests:
    name: Slow & Chaos Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Extended timeout for slow tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        run: |
          pipx install poetry==${{ env.POETRY_VERSION }}
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}-${{ env.CACHE_VERSION }}
          restore-keys: |
            venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ env.CACHE_VERSION }}-

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: |
          poetry install --no-interaction --no-root || {
            echo "Dependency install failed"
            exit 1
          }

      - name: Install project
        run: |
          poetry install --no-interaction || {
            echo "Project install failed"
            exit 1
          }

      # Run slow and chaos tests with extended timeout
      # These tests validate resilience and performance characteristics
      - name: Run slow and chaos tests
        run: |
          FILTER="${{ github.event.inputs.test_filter || 'slow or chaos' }}"
          poetry run pytest tests/ \
            --ignore=tests/integration/docker \
            -m "$FILTER" \
            -n auto \
            --timeout=600 \
            --timeout-method=thread \
            --tb=short \
            --junitxml=nightly-junit.xml \
            -v

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-test-results
          path: nightly-junit.xml
          retention-days: 30

  # Summary job to report overall status
  nightly-summary:
    name: Nightly Summary
    runs-on: ubuntu-latest
    needs: [slow-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          slow="${{ needs.slow-tests.result }}"

          if [[ "$slow" == "success" ]]; then
            echo "All nightly tests passed successfully"
            echo "Slow & Chaos Tests: Passed"
            exit 0
          else
            echo "Nightly tests failed"
            echo "Slow & Chaos Tests: $slow"
            exit 1
          fi

      - name: Post failure notification
        if: failure()
        run: |
          echo "::warning::Nightly tests failed! Review test results for details."
          echo "Run manually with: gh workflow run nightly-tests.yml"
