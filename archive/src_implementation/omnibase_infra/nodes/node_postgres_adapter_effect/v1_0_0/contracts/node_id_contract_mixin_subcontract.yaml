# Node ID from Contract Mixin Subcontract - Contract-Based Node Identification Pattern
# This subcontract defines node ID loading patterns for MixinNodeIdFromContract integration

contract_type: "node_id_contract_mixin_subcontract"
contract_version:
  major: 1
  minor: 0
  patch: 0

metadata:
  name: "NodeIdContractMixinSubcontract"
  description: "Contract-based node ID loading pattern for MixinNodeIdFromContract integration with ONEX nodes"
  author: "ONEX Framework Team"
  created: "2025-01-15"
  purpose: "Define contract-driven node identification patterns for consistent node ID management"

business_logic:
  pattern: "contract_based_node_identification"
  ai_agent:
    capabilities: ["contract_parsing", "node_id_extraction", "contract_validation", "fallback_id_generation"]
    coordination_patterns: ["contract_loader", "id_resolver", "validation_engine"]
    performance_targets:
      contract_load_time: "<50ms"
      id_resolution_time: "<10ms"
      contract_validation_time: "<25ms"

# Contract-Based Node ID Management
node_id_management:
  name: "ContractBasedNodeIdentification"
  description: "Standardized node ID loading from contract.yaml for ONEX infrastructure nodes"

  # Contract loading patterns
  contract_loading:
    contract_discovery:
      - location: "contract.yaml"
        relative_to: "node_directory"
        priority: "primary"
        required: true

      - location: "../contract.yaml"
        relative_to: "node_directory"
        priority: "fallback"
        required: false

    contract_parsing:
      - field: "node_name"
        path: "metadata.node_name"
        fallback_path: "name"
        required: true

      - field: "contract_name"
        path: "metadata.contract_name"
        fallback_path: "contract_name"
        required: false

      - field: "version"
        path: "metadata.version"
        fallback_path: "version"
        required: true

  # Node ID generation patterns
  id_generation:
    primary_strategy:
      pattern: "contract_name_based"
      source_fields: ["contract_name", "node_name"]
      format: "{contract_name}_{version_major}_{version_minor}_{version_patch}"
      validation: "alphanumeric_underscore_only"

    fallback_strategies:
      - pattern: "node_name_based"
        source_fields: ["node_name"]
        format: "{node_name}_{version_major}_{version_minor}_{version_patch}"
        condition: "contract_name_missing"

      - pattern: "directory_based"
        source_fields: ["directory_name"]
        format: "{directory_name}_{timestamp}"
        condition: "all_metadata_missing"

      - pattern: "uuid_based"
        source_fields: []
        format: "node_{uuid4}"
        condition: "complete_fallback"

# Contract Validation
contract_validation:
  validation_rules:
    required_fields:
      - path: "metadata.node_name"
        error_message: "Node name is required in contract metadata"
        severity: "error"

      - path: "metadata.version"
        error_message: "Version is required in contract metadata"
        severity: "error"

    optional_fields:
      - path: "metadata.contract_name"
        error_message: "Contract name missing, using node_name as fallback"
        severity: "warning"

      - path: "metadata.description"
        error_message: "Node description missing"
        severity: "info"

  validation_enforcement:
    strict_mode: false
    fail_on_error: true
    warn_on_missing_optional: true
    generate_fallback_ids: true

# Contract File Management
contract_file_management:
  file_discovery:
    search_paths:
      - path: "."
        filename: "contract.yaml"
        priority: 1

      - path: ".."
        filename: "contract.yaml"
        priority: 2

      - path: "../.."
        filename: "contract.yaml"
        priority: 3

    file_validation:
      check_file_exists: true
      check_file_readable: true
      check_yaml_syntax: true
      check_required_structure: true

  caching_strategy:
    cache_parsed_contracts: true
    cache_duration_minutes: 60
    invalidate_on_file_change: true
    cache_key_strategy: "file_path_hash"

# Error Handling and Recovery
error_handling:
  contract_loading_errors:
    file_not_found:
      action: "try_fallback_locations"
      fallback: "generate_directory_based_id"
      log_level: "warning"

    yaml_parsing_error:
      action: "fail_with_detailed_error"
      fallback: "none"
      log_level: "error"

    permission_denied:
      action: "try_fallback_locations"
      fallback: "generate_uuid_based_id"
      log_level: "error"

  validation_errors:
    missing_required_field:
      action: "fail_with_validation_error"
      fallback: "none"
      log_level: "error"

    invalid_field_format:
      action: "sanitize_and_continue"
      fallback: "use_sanitized_value"
      log_level: "warning"

# ID Format Standards
id_format_standards:
  naming_conventions:
    allowed_characters: "alphanumeric_underscore_hyphen"
    max_length: 128
    min_length: 3
    case_sensitivity: "preserve_original"

  versioning_integration:
    include_version: true
    version_format: "semantic_version"
    version_separator: "_"

  uniqueness_guarantees:
    ensure_uniqueness: true
    uniqueness_scope: "global_onex_system"
    collision_resolution: "append_counter"

# Performance Optimization
performance_optimization:
  loading_efficiency:
    lazy_loading: false  # Load immediately during initialization
    parallel_validation: true
    contract_preprocessing: true

  memory_management:
    contract_caching: true
    memory_cleanup: true
    gc_friendly_structures: true

# Integration Patterns
integration_patterns:
  mixin_coordination:
    initialization_order: "first"
    dependency_on: []
    provides_to: ["MixinNodeService", "MixinHealthCheck"]

  service_integration:
    node_id_availability: "during_initialization"
    id_change_notifications: false  # IDs are immutable
    external_id_registration: true

# Code Generation Targets
generation_targets:
  contract_loading:
    file_discovery_logic: true
    yaml_parsing_utilities: true
    validation_framework: true
    error_handling_patterns: true

  id_management:
    id_generation_algorithms: true
    format_validation: true
    uniqueness_enforcement: true
    caching_mechanisms: true

# Integration with Main Contract
integration:
  main_contract_field: "node_identification_configuration"
  mapping_strategy: "metadata_extraction"
  backward_compatibility: true