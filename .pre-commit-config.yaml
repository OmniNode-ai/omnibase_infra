# ONEX Infrastructure Pre-commit Configuration
# Mirrors omnibase_core settings for consistency across ONEX ecosystem
#
# PERFORMANCE OPTIMIZATION (2025-12):
# ====================================
# Two-stage validation strategy for optimal developer experience:
#
# PRE-COMMIT (target: <15 seconds):
#   - Formatting (ruff format/fix)
#   - Basic file checks (whitespace, large files, merge conflicts)
#   - Quick structural validations
#   - Security checks (secrets, private keys)
#
# PRE-PUSH (quick validation before sharing):
#   - mypy type checking (changed files only)
#
# Note: ruff replaces both black and isort (10-100x faster)
#
# USAGE:
#   pre-commit install                    # Install pre-commit hooks
#   pre-commit install --hook-type pre-push  # Install pre-push hooks
#   pre-commit run --all-files            # Run all pre-commit hooks
repos:
  # YAML formatting (standard across ecosystem)
  - repo: https://github.com/google/yamlfmt
    rev: v0.17.2
    hooks:
      - id: yamlfmt
        exclude: ^(archived/|tests/fixtures/|\.github/workflows/)
  # Essential file formatting (standard across ecosystem)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: ^\.github/workflows/
      - id: end-of-file-fixer
        exclude: ^\.github/workflows/
      - id: check-merge-conflict
      - id: check-added-large-files
        args: [--maxkb=1000]
  # ONEX Python Development Hooks (from shared templates)
  # Order: ruff format → ruff check → mypy (formatting before linting before type checking)
  # Note: ruff replaces both black and isort (10-100x faster)
  - repo: local
    hooks:
      - id: ruff-format
        name: ruff format (auto-format)
        entry: poetry run ruff format
        language: system
        types: [python]
        exclude: ^(archived/|tests/fixtures/|\.github/workflows/).*$
        stages: [pre-commit]
      - id: ruff-fix
        name: ruff check (auto-fix linting + import sorting)
        entry: poetry run ruff check --fix --exit-non-zero-on-fix
        language: system
        types: [python]
        exclude: ^(archived/|tests/fixtures/|\.github/workflows/).*$
        stages: [pre-commit]
        # Note: --exit-non-zero-on-fix ensures pre-commit fails if files were modified,
        # forcing you to re-stage the changes. This keeps pre-commit and CI in sync.
      - id: mypy-type-check
        name: mypy (type checking)
        entry: bash -c 'poetry run mypy "$@" --show-error-codes --no-error-summary' --
        language: system
        types: [python]
        files: ^src/omnibase_infra/.*\.py$
        exclude: ^(tests/|archived/).*\.py$
        pass_filenames: true # Only check changed files, not entire codebase
        stages: [pre-push] # Moved to pre-push: ~1-5s for changed files only
      # Cleanup: Clear tmp/ directory before commits
      - id: clean-tmp-directory
        name: Clean tmp directory
        entry: bash -c "rm -rf tmp/* 2>/dev/null || true"
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]
  # ONEX Validation Hooks (infrastructure-specific)
  - repo: local
    hooks:
      # Root directory cleanliness - no ephemeral files in root
      - id: onex-validate-clean-root
        name: ONEX Root Directory Cleanliness
        entry: poetry run python scripts/validate.py clean_root
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
      # Architecture validation - one model per file
      - id: onex-validate-architecture
        name: ONEX Architecture Validation
        entry: poetry run python scripts/validate.py architecture
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-commit]
      # Architecture layer validation - core/infra separation
      # Verifies omnibase_core has no infrastructure dependencies (kafka, httpx, etc.)
      #
      # NOTE: Runs in 'pre-push' stage (not pre-commit) because:
      #   1. It checks omnibase_core (external package), which adds latency
      #   2. Known issues exist that are tracked in Linear tickets
      #   3. Full validation already runs in CI (test.yml ONEX Validators job)
      #
      # Known issues: OMN-1015 (aiohttp), OMN-1295 (redis)
      # These cause expected failures until the tickets are resolved.
      #
      # Manual run: pre-commit run onex-validate-architecture-layers --hook-stage pre-push
      # Or: poetry run python scripts/validate.py architecture_layers --verbose
      - id: onex-validate-architecture-layers
        name: ONEX Architecture Layer Validation
        entry: poetry run python scripts/validate.py architecture_layers
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-push]
      # Contract validation - YAML contracts
      - id: onex-validate-contracts
        name: ONEX Contract Validation
        entry: poetry run python scripts/validate.py contracts
        language: system
        files: '\.yaml$'
        pass_filenames: false
        stages: [pre-commit]
      # Pattern validation - naming conventions
      - id: onex-validate-patterns
        name: ONEX Pattern Validation
        entry: poetry run python scripts/validate.py patterns
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-commit]
      # Naming convention validation - file and class naming [OMN-1305]
      # Validates Handler*, Dispatcher*, Store*, Adapter*, etc. naming patterns
      # Runtime: <3s (single pass with caching)
      - id: onex-validate-naming
        name: ONEX Naming Convention Validation
        entry: poetry run python scripts/validation/validate_naming.py src/omnibase_infra --errors-only
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-commit]
      # Union usage validation
      # TECH DEBT: Baseline increased to 108 violations (OMN-871)
      # Target: Reduce to 30 incrementally after PR #37 merges
      - id: onex-validate-unions
        name: ONEX Union Usage Validation
        entry: poetry run python scripts/validate.py unions
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-commit]
      # Circular import check
      - id: onex-validate-imports
        name: ONEX Circular Import Check
        entry: poetry run python scripts/validate.py imports
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-commit]
      # Any type validation (OMN-1276)
      # Ensures no `Any` types are used in the codebase
      - id: onex-validate-any-types
        name: ONEX Any Type Validation
        entry: poetry run python scripts/validate.py any_types
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-commit]
      # Declarative node enforcement
      # Ensures node.py files follow the ONEX declarative pattern:
      # - Only extend base classes, no custom methods/properties
      # - All behavior defined in contract.yaml, implemented by handlers
      # NOTE: pre-push stage because existing nodes need refactoring (OMN-XXXX)
      # Exempt nodes via: # ONEX_EXCLUDE: declarative_node
      - id: onex-validate-declarative-nodes
        name: ONEX Declarative Node Validation
        entry: poetry run python scripts/validate.py declarative_nodes
        language: system
        files: nodes/.*/node\.py$
        pass_filenames: false
        stages: [pre-push]
      # Reducer purity enforcement (OMN-914)
      # Ensures reducers remain pure functions with no I/O dependencies
      # Timeout: 60s prevents hanging if tests get stuck (normal runtime: <5s)
      - id: reducer-purity-check
        name: Reducer Purity Enforcement
        entry: poetry run pytest tests/unit/nodes/reducers/test_reducer_purity.py -v --tb=short --timeout=60 --timeout-method=thread
        language: system
        types: [python]
        files: ^src/omnibase_infra/nodes/reducers/
        pass_filenames: false
        stages: [pre-commit]
      # Markdown link validation (PR #172)
      # Ensures all internal markdown links point to existing files and anchors
      # External links are skipped by default (configurable in .markdown-link-check.json)
      - id: onex-validate-markdown-links
        name: ONEX Markdown Link Validation
        entry: poetry run python scripts/validate.py markdown_links
        language: system
        types: [markdown]
        pass_filenames: true
        stages: [pre-commit]
# Configuration
default_install_hook_types: [pre-commit, pre-push]
default_stages: [pre-commit]
fail_fast: false
# CI configuration
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes for omnibase_infra

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_schedule: weekly
  submodules: false
  # Skip ONEX validation hooks in CI that require omnibase_core imports
  # Note: onex-validate-clean-root is NOT skipped (standalone script, no omnibase_core dependency)
  skip: [onex-validate-architecture, onex-validate-architecture-layers, onex-validate-contracts, onex-validate-patterns, onex-validate-unions, onex-validate-imports, onex-validate-any-types]
