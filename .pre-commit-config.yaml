# ONEX Infrastructure Pre-commit Configuration
# Mirrors omnibase_core settings for consistency across ONEX ecosystem
#
# PERFORMANCE OPTIMIZATION (2025-12):
# ====================================
# Two-stage validation strategy for optimal developer experience:
#
# PRE-COMMIT (target: <15 seconds):
#   - Formatting (ruff format/fix)
#   - Basic file checks (whitespace, large files, merge conflicts)
#   - Quick structural validations
#   - Security checks (secrets, private keys)
#
# PRE-PUSH (quick validation before sharing):
#   - mypy type checking (changed files only)
#
# Note: ruff replaces both black and isort (10-100x faster)
#
# USAGE:
#   pre-commit install                    # Install pre-commit hooks
#   pre-commit install --hook-type pre-push  # Install pre-push hooks
#   pre-commit run --all-files            # Run all pre-commit hooks
repos:
  # YAML formatting (standard across ecosystem)
  - repo: https://github.com/google/yamlfmt
    rev: v0.17.2
    hooks:
      - id: yamlfmt
        exclude: ^(archived/|tests/fixtures/|\.github/workflows/)
  # Essential file formatting (standard across ecosystem)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: ^\.github/workflows/
      - id: end-of-file-fixer
        exclude: ^\.github/workflows/
      - id: check-merge-conflict
      - id: check-added-large-files
        args: [--maxkb=1000]
  # ONEX Python Development Hooks (from shared templates)
  # Order: ruff format → ruff check → mypy (formatting before linting before type checking)
  # Note: ruff replaces both black and isort (10-100x faster)
  - repo: local
    hooks:
      - id: ruff-format
        name: ruff format (auto-format)
        entry: poetry run ruff format
        language: system
        types: [python]
        exclude: ^(archived/|tests/fixtures/|\.github/workflows/).*$
        stages: [pre-commit]
      - id: ruff-fix
        name: ruff check (auto-fix linting + import sorting)
        entry: poetry run ruff check --fix --exit-non-zero-on-fix
        language: system
        types: [python]
        exclude: ^(archived/|tests/fixtures/|\.github/workflows/).*$
        stages: [pre-commit]
        # Note: --exit-non-zero-on-fix ensures pre-commit fails if files were modified,
        # forcing you to re-stage the changes. This keeps pre-commit and CI in sync.
      - id: mypy-type-check
        name: mypy (type checking)
        entry: bash -c 'poetry run mypy "$@" --show-error-codes --no-error-summary' --
        language: system
        types: [python]
        files: ^src/omnibase_infra/.*\.py$
        exclude: ^(tests/|archived/).*\.py$
        pass_filenames: true # Only check changed files, not entire codebase
        stages: [pre-push] # Moved to pre-push: ~1-5s for changed files only
      # Cleanup: Clear tmp/ directory before commits
      - id: clean-tmp-directory
        name: Clean tmp directory
        entry: bash -c "rm -rf tmp/* 2>/dev/null || true"
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]
  # ONEX Validation Hooks (infrastructure-specific)
  - repo: local
    hooks:
      # Architecture validation - one model per file
      - id: onex-validate-architecture
        name: ONEX Architecture Validation
        entry: poetry run python scripts/validate.py architecture
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-commit]
      # Contract validation - YAML contracts
      - id: onex-validate-contracts
        name: ONEX Contract Validation
        entry: poetry run python scripts/validate.py contracts
        language: system
        files: '\.yaml$'
        pass_filenames: false
        stages: [pre-commit]
      # Pattern validation - naming conventions
      - id: onex-validate-patterns
        name: ONEX Pattern Validation
        entry: poetry run python scripts/validate.py patterns
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-commit]
      # Union usage validation
      # TECH DEBT: Baseline increased to 108 violations (OMN-871)
      # Target: Reduce to 30 incrementally after PR #37 merges
      - id: onex-validate-unions
        name: ONEX Union Usage Validation
        entry: poetry run python scripts/validate.py unions
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-commit]
      # Circular import check
      - id: onex-validate-imports
        name: ONEX Circular Import Check
        entry: poetry run python scripts/validate.py imports
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-commit]
      # Any type validation (OMN-1276)
      # Ensures no `Any` types are used in the codebase
      - id: onex-validate-any-types
        name: ONEX Any Type Validation
        entry: poetry run python scripts/validate.py any_types
        language: system
        types: [python]
        pass_filenames: false
        stages: [pre-commit]
      # Reducer purity enforcement (OMN-914)
      # Ensures reducers remain pure functions with no I/O dependencies
      # Timeout: 60s prevents hanging if tests get stuck (normal runtime: <5s)
      - id: reducer-purity-check
        name: Reducer Purity Enforcement
        entry: poetry run pytest tests/unit/nodes/reducers/test_reducer_purity.py -v --tb=short --timeout=60 --timeout-method=thread
        language: system
        types: [python]
        files: ^src/omnibase_infra/nodes/reducers/
        pass_filenames: false
        stages: [pre-commit]
# Configuration
default_install_hook_types: [pre-commit, pre-push]
default_stages: [pre-commit]
fail_fast: false
# CI configuration
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes for omnibase_infra

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_schedule: weekly
  submodules: false
  # Skip ONEX validation hooks in CI (they require omnibase_core)
  skip: [onex-validate-architecture, onex-validate-contracts, onex-validate-patterns, onex-validate-unions, onex-validate-imports, onex-validate-any-types]
