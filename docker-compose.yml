version: '3.8'

networks:
  omnibase-network:
    driver: bridge

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15
    container_name: omnibase-infra-postgres
    networks:
      - omnibase-network
    environment:
      POSTGRES_DB: omnibase_infrastructure
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5435:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d omnibase_infrastructure"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RedPanda - High-performance Kafka-compatible streaming
  redpanda:
    image: redpandadata/redpanda:v24.2.7
    container_name: omnibase-infra-redpanda
    networks:
      - omnibase-network
    ports:
      - "${REDPANDA_PORT:-9092}:9092"           # Kafka API
      - "${REDPANDA_EXTERNAL_PORT:-29102}:29092" # External Kafka API
      - "${REDPANDA_ADMIN_PORT:-9654}:9644"     # Admin API
      - "${REDPANDA_PROXY_PORT:-8092}:8082"     # HTTP Proxy API
    command:
      - redpanda
      - start
      - --kafka-addr=internal://0.0.0.0:9092,external://0.0.0.0:29092
      - --advertise-kafka-addr=internal://omnibase-infra-redpanda:9092,external://localhost:29092
      - --pandaproxy-addr=internal://0.0.0.0:8082,external://0.0.0.0:8083
      - --advertise-pandaproxy-addr=internal://omnibase-infra-redpanda:8082,external://localhost:8083
      - --schema-registry-addr=internal://0.0.0.0:8081,external://0.0.0.0:8084
      - --rpc-addr=omnibase-infra-redpanda:33145
      - --advertise-rpc-addr=omnibase-infra-redpanda:33145
      - --mode=dev-container
      - --smp=1
      - --default-log-level=${REDPANDA_LOG_LEVEL:-info}
    environment:
      REDPANDA_AUTO_CREATE_TOPICS_ENABLED: true
      REDPANDA_DEFAULT_TOPIC_PARTITIONS: ${REDPANDA_DEFAULT_PARTITIONS:-3}
      REDPANDA_DEFAULT_TOPIC_REPLICATIONS: ${REDPANDA_DEFAULT_REPLICATION_FACTOR:-1}
      REDPANDA_TOPIC_CLEANUP_POLICY: delete
      REDPANDA_LOG_RETENTION_MS: ${REDPANDA_LOG_RETENTION_MS:-604800000} # 7 days
      REDPANDA_SEGMENT_MS: ${REDPANDA_SEGMENT_MS:-86400000} # 1 day
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD", "rpk", "cluster", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # RedPanda Topic Manager - Setup ONEX infrastructure topics
  redpanda-topic-manager:
    image: redpandadata/redpanda:v24.2.7
    container_name: omnibase-infra-redpanda-topics
    networks:
      - omnibase-network
    depends_on:
      redpanda:
        condition: service_healthy
    command: >
      sh -c "
        echo 'Waiting for RedPanda to be ready...' &&
        rpk cluster info --brokers omnibase-infra-redpanda:9092 &&
        echo 'Creating OmniNode infrastructure topics (dev.omnibase.onex)...' &&
        
        echo 'PostgreSQL Command Topics...' &&
        rpk topic create dev.omnibase.onex.cmd.postgres-execute-query.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        rpk topic create dev.omnibase.onex.cmd.postgres-health-check.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        
        echo 'PostgreSQL Event Topics...' &&
        rpk topic create dev.omnibase.onex.evt.postgres-query-completed.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        rpk topic create dev.omnibase.onex.evt.postgres-query-failed.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        rpk topic create dev.omnibase.onex.evt.postgres-connection-established.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        rpk topic create dev.omnibase.onex.evt.postgres-connection-failed.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        
        echo 'PostgreSQL Query-Response Topics...' &&
        rpk topic create dev.omnibase.onex.qrs.postgres-health-requests.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        rpk topic create dev.omnibase.onex.qrs.postgres-health-replies.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        rpk topic create dev.omnibase.onex.qrs.postgres-health-response.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        
        echo 'PostgreSQL CDC Topics...' &&
        rpk topic create dev.omnibase.onex.cdc.postgres-schema-changes.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        
        echo 'PostgreSQL Retry/DLT Topics...' &&
        rpk topic create dev.omnibase.onex.rty.postgres-execute-query.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        rpk topic create dev.omnibase.onex.dlt.postgres-execute-query.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        
        echo 'Infrastructure Audit/Metrics Topics...' &&
        rpk topic create dev.omnibase.onex.aud.postgres-operations.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        rpk topic create dev.omnibase.onex.met.postgres-performance.v1 --brokers omnibase-infra-redpanda:9092 --partitions 3 --replicas 1 || true &&
        
        echo 'OmniNode infrastructure topic creation completed'
      "
    healthcheck:
      test: ["CMD", "rpk", "topic", "list", "--brokers", "omnibase-infra-redpanda:9092"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: "no"

  # RedPanda UI (Development) - Web interface for topic management
  redpanda-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: omnibase-infra-redpanda-ui
    networks:
      - omnibase-network
    depends_on:
      redpanda:
        condition: service_healthy
    ports:
      - "${REDPANDA_UI_PORT:-8109}:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: omnibase-infra-redpanda
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: omnibase-infra-redpanda:9092
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: http://omnibase-infra-redpanda:8081
      SERVER_SERVLET_CONTEXT_PATH: /
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - development

  # PostgreSQL Adapter Node
  postgres-adapter:
    build: 
      context: .
      secrets:
        - github_token
    container_name: omnibase-infra-postgres-adapter
    networks:
      - omnibase-network
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: omnibase_infrastructure
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      KAFKA_BOOTSTRAP_SERVERS: omnibase-infra-redpanda:9092
    ports:
      - "${POSTGRES_ADAPTER_PORT:-8085}:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

secrets:
  github_token:
    environment: "GITHUB_TOKEN"

volumes:
  postgres_data:
  redpanda_data: