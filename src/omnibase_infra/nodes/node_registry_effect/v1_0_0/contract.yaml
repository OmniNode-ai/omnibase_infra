# SPDX-License-Identifier: MIT
# Copyright (c) 2025 OmniNode Team
# ONEX Node Contract - Registry Effect Node
contract_version: "1.0.0"
node_version: "1.0.0"
name: "node_registry_effect"
node_type: "EFFECT"
description: "Registry effect node for dual registration to Consul and PostgreSQL. Bridges message bus events to external infrastructure services for service discovery and persistent state management."
input_model:
  name: "ModelRegistryRequest"
  module: "omnibase_infra.nodes.node_registry_effect.v1_0_0.models"
  description: "Request model for registry operations including service registration, discovery, and state persistence."
output_model:
  name: "ModelRegistryResponse"
  module: "omnibase_infra.nodes.node_registry_effect.v1_0_0.models"
  description: "Response model containing operation results from Consul and PostgreSQL with unified status."
io_operations:
  - type: "service_discovery"
    description: "Consul service discovery operations for dynamic service registration and health checks."
    operations:
      - "register"
      - "deregister"
      - "discover"
    target: "consul"
  - type: "database"
    description: "PostgreSQL database operations for persistent registry state management."
    operations:
      - "create"
      - "update"
      - "delete"
      - "query"
    target: "postgresql"
  - type: "event_bus"
    description: "Event bus operations for publishing registry state changes. Resolved via ProtocolEventBus interface - production uses KafkaEventBus, testing uses InMemoryEventBus."
    operations:
      - "publish"
    target: "protocol:ProtocolEventBus" # Protocol-based: KafkaEventBus (prod), InMemoryEventBus (test)
event_channels:
  subscribes_to:
    - topic: "onex.node.introspection.published.v1"
      description: "Node capability announcements for registration processing"
      key_field: "node_id"
    - topic: "onex.node.heartbeat.published.v1"
      description: "Periodic liveness signals from registered nodes"
      key_field: "node_id"
  publishes_to:
    - topic: "onex.registry.node.registered.v1"
      description: "Emitted when node registration completes successfully"
      key_field: "node_id"
    - topic: "onex.registry.node.registration_failed.v1"
      description: "Emitted when node registration fails"
      key_field: "node_id"
    - topic: "onex.registry.node.deregistered.v1"
      description: "Emitted when node is deregistered"
      key_field: "node_id"
dependencies:
  - name: "consul_handler"
    type: "handler"
    class_name: "ConsulHandler"
    module: "omnibase_infra.handlers.handler_consul"
    description: "HashiCorp Consul handler for service discovery operations."
  - name: "db_handler"
    type: "handler"
    class_name: "DbAdapter"
    module: "omnibase_infra.handlers.handler_db"
    description: "PostgreSQL database handler for persistent state operations."
  - name: "event_bus"
    type: "event_bus"
    protocol: "ProtocolEventBus"
    production_class: "KafkaEventBus"
    production_module: "omnibase_infra.event_bus.kafka_event_bus"
    description: "Event bus for publishing registry state change events (introspection requests). Resolved via ProtocolEventBus - production uses KafkaEventBus, testing uses InMemoryEventBus."
error_handling:
  retry_policy:
    max_retries: 3
    backoff_strategy: "exponential"
    initial_delay_ms: 100
    max_delay_ms: 5000
  circuit_breaker:
    failure_threshold: 5
    reset_timeout_seconds: 60
    half_open_requests: 1
  error_types:
    - name: "InfraConnectionError"
      module: "omnibase_infra.errors"
      recoverable: true
    - name: "InfraTimeoutError"
      module: "omnibase_infra.errors"
      recoverable: true
    - name: "InfraUnavailableError"
      module: "omnibase_infra.errors"
      recoverable: true
    - name: "InfraAuthenticationError"
      module: "omnibase_infra.errors"
      recoverable: false
health_check:
  enabled: true
  interval_seconds: 30
  timeout_seconds: 10
  failure_threshold: 3
metadata:
  author: "OmniNode Team"
  created: "2025-12-17"
  tags:
    - "infrastructure"
    - "registry"
    - "consul"
    - "postgresql"
    - "effect-node"
