# SPDX-License-Identifier: MIT
# Copyright (c) 2025 OmniNode Team
#
# ONEX Node Contract
# Node: NodeRegistryEffect
#
# This contract defines the interface for the Registry Effect node,
# which handles dual-backend node registration against Consul and PostgreSQL.
# The node uses declarative operation routing to dispatch operations to
# backend-specific handlers.
# Contract identifiers
name: "node_registry_effect"
contract_name: "node_registry_effect"
node_name: "node_registry_effect"
# Version (semantic versioning)
version:
  major: 1
  minor: 1
  patch: 0
contract_version:
  major: 1
  minor: 1
  patch: 0
node_version:
  major: 1
  minor: 1
  patch: 0
# Node type
node_type: "EFFECT"
# Description
description: >
  Effect node for dual-backend node registration. Executes registration operations against both Consul (service discovery) and PostgreSQL (registration record persistence), with support for partial failure handling and targeted retries. Uses declarative operation routing to dispatch to backend-specific handlers.

# Strongly typed I/O models
input_model:
  name: "ModelRegistryRequest"
  module: "omnibase_infra.nodes.node_registry_effect.models"
  description: "Input model containing operation type and registration parameters."
output_model:
  name: "ModelRegistryResponse"
  module: "omnibase_infra.nodes.node_registry_effect.models"
  description: "Output model containing backend status and registration outcome."
# =============================================================================
# OPERATION ROUTING (Declarative Handler Dispatch)
# =============================================================================
# This section defines how operations are routed to backend-specific handlers.
# The routing strategy determines handler selection based on operation type
# and target backend.
#
# Design Rationale:
#   - Parallel execution for independent backends (Consul + Postgres)
#   - Partial failure handling allows one backend to succeed even if other fails
#   - Each handler is responsible for a single backend operation
#
# Execution Flow:
#   1. Receive ModelRegistryRequest with operation type
#   2. Route to all matching handlers based on operation
#   3. Execute handlers in parallel (for dual-backend operations)
#   4. Aggregate results with partial failure handling
#   5. Return ModelRegistryResponse with combined status
# =============================================================================
operation_routing:
  routing_strategy: "operation_match"
  operations:
    # Register Node - Consul Backend
    # Registers service with Consul for service discovery.
    # Uses health check endpoint for automated liveness monitoring.
    - operation: "register_node"
      handler:
        name: "HandlerConsulRegister"
        module: "omnibase_infra.nodes.node_registry_effect.handlers.handler_consul_register"
      backend: "consul"
      description: "Register node with Consul service discovery"
      output_fields:
        - consul_registered
        - consul_service_id
    # Register Node - PostgreSQL Backend
    # Persists registration record to PostgreSQL for durability.
    # Uses upsert semantics for idempotent re-registration.
    - operation: "register_node"
      handler:
        name: "HandlerPostgresUpsert"
        module: "omnibase_infra.nodes.node_registry_effect.handlers.handler_postgres_upsert"
      backend: "postgres"
      description: "Persist node registration to PostgreSQL"
      output_fields:
        - postgres_registered
        - registration_id
    # Deregister Node - Consul Backend
    # Removes service from Consul to stop routing traffic.
    - operation: "deregister_node"
      handler:
        name: "HandlerConsulDeregister"
        module: "omnibase_infra.nodes.node_registry_effect.handlers.handler_consul_deregister"
      backend: "consul"
      description: "Deregister node from Consul service discovery"
      output_fields:
        - consul_deregistered
    # Deregister Node - PostgreSQL Backend
    # Marks registration record as inactive in PostgreSQL.
    - operation: "deregister_node"
      handler:
        name: "HandlerPostgresDeactivate"
        module: "omnibase_infra.nodes.node_registry_effect.handlers.handler_postgres_deactivate"
      backend: "postgres"
      description: "Mark node registration as inactive in PostgreSQL"
      output_fields:
        - postgres_deregistered
    # Retry Partial Failure - Targeted Backend
    # Retries a specific backend after partial failure.
    # Uses idempotency key to ensure safe retry semantics.
    - operation: "retry_partial_failure"
      handler:
        name: "HandlerPartialRetry"
        module: "omnibase_infra.nodes.node_registry_effect.handlers.handler_partial_retry"
      backend: "dynamic"
      description: "Retry registration for specific backend after partial failure"
      dynamic_backend_field: "target_backend"
      output_fields:
        - success
        - backend_status
  # Execution configuration
  execution_mode: "parallel"
  partial_failure_handling: true
  aggregation_strategy: "all_or_partial"
# =============================================================================
# ERROR HANDLING (Circuit Breaker + Retry + Sanitization)
# =============================================================================
# Error handling configuration following ONEX infrastructure patterns.
# Uses circuit breakers for backend protection and retry policies for
# transient failure recovery.
#
# Error Flow:
#   1. Operation fails -> Check if error is retriable
#   2. Retry with exponential backoff if retriable
#   3. After max retries, check circuit breaker state
#   4. Open circuit if failure threshold exceeded
#   5. Sanitize error before logging/returning
# =============================================================================
error_handling:
  # Circuit breaker configuration
  # Prevents cascading failures by stopping requests to failing backends.
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    reset_timeout_ms: 60000
    half_open_max_requests: 3
    per_backend: true
    backends:
      - name: "consul"
        failure_threshold: 5
        reset_timeout_ms: 60000
      - name: "postgres"
        failure_threshold: 5
        reset_timeout_ms: 60000
  # Retry policy with exponential backoff
  # Handles transient infrastructure failures.
  retry_policy:
    max_retries: 3
    initial_delay_ms: 100
    max_delay_ms: 5000
    exponential_base: 2
    retry_on:
      - "InfraConnectionError"
      - "InfraTimeoutError"
      - "InfraUnavailableError"
  # Error sanitization
  # Removes sensitive information from error messages before logging.
  error_sanitization:
    enabled: true
    utility: "omnibase_infra.shared.utils.util_error_sanitization"
    sanitize_patterns:
      - "password"
      - "secret"
      - "token"
      - "api_key"
      - "connection_string"
  # Error type definitions
  error_types:
    - name: "InfraConnectionError"
      description: "Failed to connect to backend service"
      recoverable: true
      retry_strategy: "exponential_backoff"
    - name: "InfraTimeoutError"
      description: "Backend operation timed out"
      recoverable: true
      retry_strategy: "exponential_backoff"
    - name: "InfraAuthenticationError"
      description: "Authentication failed with backend"
      recoverable: false
      retry_strategy: "none"
    - name: "InfraUnavailableError"
      description: "Backend service is unavailable (circuit open)"
      recoverable: true
      retry_strategy: "exponential_backoff"
# IO operations (EFFECT node specific)
io_operations:
  - operation: "register_node"
    description: "Register a node with both Consul and PostgreSQL backends"
    input_fields:
      - node_id
      - service_name
      - health_endpoint
      - metadata
    output_fields:
      - consul_registered
      - postgres_registered
      - registration_id
  - operation: "deregister_node"
    description: "Deregister a node from both backends"
    input_fields:
      - node_id
      - service_name
    output_fields:
      - consul_deregistered
      - postgres_deregistered
  - operation: "retry_partial_failure"
    description: "Retry registration for a specific backend after partial failure"
    input_fields:
      - node_id
      - target_backend
      - idempotency_key
    output_fields:
      - success
      - backend_status
# Dependencies (protocols this node requires)
dependencies:
  - name: "protocol_consul_client"
    type: "protocol"
    class_name: "ProtocolConsulClient"
    module: "omnibase_infra.nodes.effects.protocol_consul_client"
    description: "Consul service discovery operations"
  - name: "protocol_postgres_adapter"
    type: "protocol"
    class_name: "ProtocolPostgresAdapter"
    module: "omnibase_infra.nodes.effects.protocol_postgres_adapter"
    description: "PostgreSQL registration persistence"
  - name: "protocol_effect_idempotency_store"
    type: "protocol"
    class_name: "ProtocolEffectIdempotencyStore"
    module: "omnibase_infra.nodes.effects.protocol_effect_idempotency_store"
    description: "Idempotency tracking for retry safety"
  - name: "protocol_circuit_breaker_aware"
    type: "protocol"
    class_name: "ProtocolCircuitBreakerAware"
    module: "omnibase_infra.mixins.protocol_circuit_breaker_aware"
    description: "Circuit breaker awareness for backend protection"
# Capabilities provided by this node
capabilities:
  - name: "dual_backend_registration"
    description: "Register nodes with both Consul and PostgreSQL simultaneously"
  - name: "partial_failure_handling"
    description: "Handle and recover from partial registration failures"
  - name: "targeted_retry"
    description: "Retry specific backend operations independently"
  - name: "idempotent_operations"
    description: "Ensure operations are idempotent via idempotency store"
  - name: "circuit_breaker_protection"
    description: "Protect backends with circuit breaker pattern"
  - name: "parallel_execution"
    description: "Execute backend operations in parallel for reduced latency"
# Model definitions
definitions:
  ModelRegistryRequest:
    type: object
    description: "Input model for registry effect operations"
    properties:
      operation:
        type: string
        description: "Operation to perform (register_node, deregister_node, retry_partial_failure)"
        enum:
          - "register_node"
          - "deregister_node"
          - "retry_partial_failure"
      node_id:
        type: string
        description: "Unique identifier for the node"
      service_name:
        type: string
        description: "Service name for registration"
      health_endpoint:
        type: string
        description: "Health check endpoint URL"
      metadata:
        type: object
        description: "Additional metadata for registration"
      target_backend:
        type: string
        description: "Target backend for retry operations (consul, postgres)"
        enum:
          - "consul"
          - "postgres"
      idempotency_key:
        type: string
        description: "Idempotency key for operation deduplication"
      correlation_id:
        type: string
        description: "Request correlation ID for tracing"
    required:
      - operation
      - node_id
      - correlation_id
  ModelRegistryResponse:
    type: object
    description: "Output model for registry effect operations"
    properties:
      success:
        type: boolean
        description: "Whether the operation succeeded (all backends)"
      consul_registered:
        type: boolean
        description: "Whether Consul registration succeeded"
      postgres_registered:
        type: boolean
        description: "Whether PostgreSQL registration succeeded"
      consul_service_id:
        type: string
        description: "Consul service ID for the registered node"
      registration_id:
        type: string
        description: "PostgreSQL registration record ID"
      partial_failure:
        type: boolean
        description: "Whether a partial failure occurred"
      failed_backend:
        type: string
        description: "Which backend failed (if partial failure)"
        enum:
          - "consul"
          - "postgres"
      error_message:
        type: string
        description: "Sanitized error message if operation failed"
      correlation_id:
        type: string
        description: "Request correlation ID for tracing"
      execution_time_ms:
        type: integer
        description: "Total execution time in milliseconds"
    required:
      - success
      - correlation_id
# Health check configuration
health_check:
  enabled: true
  endpoint: "/health"
  interval_seconds: 30
  backends:
    - name: "consul"
      check_type: "http"
      endpoint: "/v1/status/leader"
    - name: "postgres"
      check_type: "connection"
      timeout_ms: 5000
# Metadata
metadata:
  author: "OmniNode Team"
  license: "MIT"
  created: "2025-01-01"
  updated: "2025-01-06"
  tags:
    - effect
    - registration
    - consul
    - postgresql
    - dual-backend
    - idempotency
    - circuit-breaker
    - parallel-execution
