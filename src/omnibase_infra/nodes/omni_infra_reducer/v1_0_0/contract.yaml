# NodeOmniInfraReducer Contract - Pure State Aggregation with DB Storage
# Aggregates infrastructure state from all adapters and stores in PostgreSQL

contract_version: {major: 1, minor: 0, patch: 0}
node_name: "omni_infra_reducer"
node_version: {major: 1, minor: 0, patch: 0}
contract_name: "omni_infra_reducer_contract"
description: "Pure infrastructure state reducer with database-backed state storage"
node_type: "REDUCER"
name: "omni_infra_reducer"
version: {major: 1, minor: 0, patch: 0}
input_model: "ModelOmniInfraReducerInput"
output_model: "ModelOmniInfraReducerOutput"

# Metadata
uuid: "omni-infra-reducer-uuid-v1"
created_at: "2025-11-14T12:00:00Z"
last_modified_at: "2025-11-14T12:00:00Z"
hash: "sha256:reducer-v1"
entrypoint: "omnibase_infra.nodes.omni_infra_reducer.v1_0_0.node:NodeOmniInfraReducer"
namespace: "omnibase_infra.infrastructure"
author: "ONEX"

# Node Specification
node_specification:
  node_name: "omni_infra_reducer"
  version: {major: 1, minor: 0, patch: 0}
  description: "Pure infrastructure state reducer - aggregates state from all adapters"
  main_node_class: "NodeOmniInfraReducer"
  container_injection: "ONEXContainer"
  business_logic_pattern: "reducer"
  state_storage: "database"  # All state stored in PostgreSQL
  purity: true  # Pure function - no in-memory state

# Capabilities
capabilities:
  - name: "health_state_aggregation"
    description: "Aggregate health status from all infrastructure adapters"

  - name: "metrics_consolidation"
    description: "Consolidate performance metrics across postgres, kafka, consul"

  - name: "circuit_breaker_state_tracking"
    description: "Track circuit breaker states across all services"

  - name: "connection_pool_monitoring"
    description: "Monitor connection pool health across all adapters"

  - name: "intent_emission"
    description: "Emit intents to orchestrator based on aggregated state"

# Dependencies
dependencies:
  # Event bus for consuming adapter events
  - name: "protocol_event_bus"
    type: "protocol"
    class_name: "ProtocolEventBus"
    module: "omnibase_core.protocol.protocol_event_bus"

  # PostgreSQL adapter for state persistence
  - name: "postgres_adapter"
    type: "node"
    class_name: "NodePostgresAdapterEffect"
    module: "omnibase_infra.nodes.postgres_adapter.v1_0_0.node"
    description: "Required for storing aggregated state in database"

# Event Consumption (Reducer consumes events from adapters)
event_consumption:
  subscribed_topics:
    - "postgres-query-completed"
    - "postgres-query-failed"
    - "postgres-health-response"
    - "kafka-message-published"
    - "kafka-health-response"
    - "consul-kv-updated"
    - "consul-service-registered"
    - "consul-health-check"

  consumer_group: "omni_infra_reducer_consumers"

  consumed_event_types:
    - "POSTGRES_QUERY_COMPLETED"
    - "POSTGRES_QUERY_FAILED"
    - "POSTGRES_HEALTH_RESPONSE"
    - "KAFKA_MESSAGE_PUBLISHED"
    - "KAFKA_HEALTH_RESPONSE"
    - "CONSUL_KV_UPDATED"
    - "CONSUL_SERVICE_REGISTERED"
    - "CONSUL_HEALTH_CHECK"

# Intent Emission (Reducer emits intents to orchestrator)
intent_emission:
  published_intents:
    - "infrastructure_health_degraded"
    - "infrastructure_health_critical"
    - "circuit_breaker_opened"
    - "connection_pool_exhausted"
    - "failover_required"
    - "recovery_initiated"

  intent_routing: "omni_infra_orchestrator"

# State Schema (Stored in PostgreSQL)
state_schema:
  tables:
    - name: "infrastructure_state"
      description: "Current aggregated infrastructure state"
      columns:
        - name: "state_id"
          type: "uuid"
          primary_key: true
        - name: "timestamp"
          type: "timestamp"
          indexed: true
        - name: "adapter_type"
          type: "string"
          description: "postgres | kafka | consul"
        - name: "health_status"
          type: "string"
          description: "healthy | degraded | unhealthy"
        - name: "circuit_breaker_state"
          type: "string"
          description: "closed | half_open | open"
        - name: "connection_pool_size"
          type: "integer"
        - name: "active_connections"
          type: "integer"
        - name: "metrics_json"
          type: "jsonb"
          description: "Detailed metrics payload"

    - name: "infrastructure_intents"
      description: "Emitted intents for orchestrator"
      columns:
        - name: "intent_id"
          type: "uuid"
          primary_key: true
        - name: "intent_type"
          type: "string"
        - name: "timestamp"
          type: "timestamp"
        - name: "source_adapter"
          type: "string"
        - name: "intent_data"
          type: "jsonb"
        - name: "processed"
          type: "boolean"
          default: false

# Definitions
definitions:
  models:
    ModelOmniInfraReducerInput:
      type: "object"
      description: "Input for reducer - event from infrastructure adapter"
      properties:
        event_type:
          type: "string"
          description: "Type of infrastructure event"
        adapter_source:
          type: "string"
          enum: ["postgres", "kafka", "consul"]
        event_payload:
          type: "object"
          description: "Event-specific payload"
        correlation_id:
          type: "string"
          format: "uuid"
        timestamp:
          type: "number"
      required: ["event_type", "adapter_source", "correlation_id", "timestamp"]

    ModelOmniInfraReducerOutput:
      type: "object"
      description: "Output from reducer - state update and intent emission"
      properties:
        state_updated:
          type: "boolean"
          description: "Whether state was successfully stored in DB"
        state_id:
          type: "string"
          format: "uuid"
          description: "ID of stored state record"
        intents_emitted:
          type: "array"
          items:
            type: "string"
          description: "List of intent types emitted to orchestrator"
        correlation_id:
          type: "string"
          format: "uuid"
        timestamp:
          type: "number"
      required: ["state_updated", "correlation_id", "timestamp"]

  schemas: {}
  responses: {}
