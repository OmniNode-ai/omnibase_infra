# Infrastructure PostgreSQL Adapter - ONEX Contract
# Effect node for PostgreSQL database operations via message bus integration

# === REQUIRED ROOT FIELDS ===
contract_version: {major: 1, minor: 0, patch: 0}
node_name: "postgres_adapter"
node_version: {major: 1, minor: 0, patch: 0}
contract_name: "postgres_adapter_contract"
description: "Infrastructure PostgreSQL Adapter - Message Bus to PostgreSQL Database Bridge"
node_type: "EFFECT"
name: "postgres_adapter"
version: {major: 1, minor: 0, patch: 0}
input_model: "ModelPostgresAdapterInput"
output_model: "ModelPostgresAdapterOutput"

# === NODE SPECIFICATION ===
node_specification:
  node_name: "postgres_adapter"
  version: {major: 1, minor: 0, patch: 0}
  description: "Infrastructure PostgreSQL Adapter - Message Bus to PostgreSQL Database Bridge"
  main_node_class: "Node"
  container_injection: "ONEXContainer"
  business_logic_pattern: "effect"

# === DEPENDENCIES ===
dependencies:
  - name: "protocol_database_client"
    type: "protocol"
    class_name: "ProtocolDatabaseClient"
    module: "omnibase_core.protocol.protocol_database_client"
  - name: "protocol_event_bus"
    type: "protocol"
    class_name: "ProtocolEventBus"
    module: "omnibase_core.protocol.protocol_event_bus"
  - name: "protocol_connection_pool"
    type: "protocol"
    class_name: "ProtocolConnectionPool"
    module: "omnibase_core.protocol.protocol_connection_pool"
  - name: "postgres_connection_manager"
    type: "protocol"
    class_name: "PostgresConnectionManager"
    module: "omnibase_infra.infrastructure.postgres_connection_manager"

# === SHARED MODEL DEPENDENCIES ===
shared_model_dependencies:
  - name: "model_postgres_query_request"
    type: "model"
    class_name: "ModelPostgresQueryRequest"
    module: "omnibase_infra.models.postgres.model_postgres_query_request"
    description: "Shared PostgreSQL query request model"
  
  - name: "model_postgres_query_response"
    type: "model"
    class_name: "ModelPostgresQueryResponse"
    module: "omnibase_infra.models.postgres.model_postgres_query_response"
    description: "Shared PostgreSQL query response model"
  
  - name: "model_postgres_health_request"
    type: "model"
    class_name: "ModelPostgresHealthRequest"
    module: "omnibase_infra.models.postgres.model_postgres_health_request"
    description: "Shared PostgreSQL health check request model"
  
  - name: "model_postgres_health_response"
    type: "model"
    class_name: "ModelPostgresHealthResponse"
    module: "omnibase_infra.models.postgres.model_postgres_health_response"
    description: "Shared PostgreSQL health check response model"
  
  - name: "model_postgres_connection_config"
    type: "model"
    class_name: "ModelPostgresConnectionConfig"
    module: "omnibase_infra.models.postgres.model_postgres_connection_config"
    description: "Shared PostgreSQL connection configuration model"

# === EVENT TYPE CONFIGURATION ===
event_type:
  primary_events: ["postgres_query_operation", "postgres_transaction_operation", "postgres_health_check"]
  event_categories: ["infrastructure", "database", "persistence"]
  publish_events: true
  subscribe_events: false
  event_routing: "infrastructure"

# === INPUT/OUTPUT STATE ===
input_state:
  object_type: "object"
  required:
    - "operation_type"
    - "correlation_id"
    - "timestamp"
  properties:
    operation_type:
      property_type: "string"
      enum: ["query", "health_check"]
      description: "Type of PostgreSQL operation to perform"
    
    query_request:
      property_type: "object"
      description: "Query request payload (when operation_type is 'query')"
      reference: "ModelPostgresQueryRequest"
    
    health_request:
      property_type: "object"
      description: "Health check request payload (when operation_type is 'health_check')"
      reference: "ModelPostgresHealthRequest"
    
    correlation_id:
      property_type: "string"
      description: "Request correlation ID for tracing"
      format: "uuid"
    
    timestamp:
      property_type: "number"
      description: "Request timestamp"
    
    context:
      property_type: "object"
      description: "Additional request context"

output_state:
  object_type: "object"
  properties:
    operation_type:
      property_type: "string"
      description: "Type of operation that was executed"
      enum: ["query", "health_check"]
    
    query_response:
      property_type: "object"
      description: "Query response payload (when operation_type is 'query')"
      reference: "ModelPostgresQueryResponse"
    
    health_response:
      property_type: "object"
      description: "Health check response payload (when operation_type is 'health_check')"
      reference: "ModelPostgresHealthResponse"
    
    success:
      property_type: "boolean"
      description: "Whether the operation was successful"
    
    error_message:
      property_type: "string"
      description: "Error message if operation failed"
    
    correlation_id:
      property_type: "string"
      description: "Request correlation ID for tracing"
      format: "uuid"
    
    timestamp:
      property_type: "number"
      description: "Response timestamp"
    
    execution_time_ms:
      property_type: "number"
      description: "Total operation execution time in milliseconds"

# === IO OPERATIONS (Required for EFFECT nodes) ===
io_operations:
  - operation_type: "postgres_query_execution"
    atomic: true
    backup_enabled: false
    permissions: null
    recursive: false
    buffer_size: 8192
    timeout_seconds: 30
    validation_enabled: true
  
  - operation_type: "postgres_transaction_execution"
    atomic: true
    backup_enabled: true
    permissions: null
    recursive: false
    buffer_size: 16384
    timeout_seconds: 60
    validation_enabled: true
  
  - operation_type: "postgres_health_check"
    atomic: false
    backup_enabled: false
    permissions: null
    recursive: false
    buffer_size: 4096
    timeout_seconds: 5
    validation_enabled: true
  
  - operation_type: "postgres_connection_management"
    atomic: false
    backup_enabled: false
    permissions: null
    recursive: false
    buffer_size: 2048
    timeout_seconds: 10
    validation_enabled: true

# === SUBCONTRACTS ===
subcontracts:
  - name: "postgres_event_processing_subcontract"
    path: "./contracts/postgres_event_processing_subcontract.yaml"
    description: "Event bus integration patterns for PostgreSQL operations"
    integration_type: "mixin"
    
  - name: "postgres_connection_management_subcontract"
    path: "./contracts/postgres_connection_management_subcontract.yaml"
    description: "Connection pool and database management patterns"
    integration_type: "mixin"

# === DEFINITIONS (Required by ModelContractContent) ===
definitions:
  models:
    ModelPostgresAdapterInput:
      type: "object"
      description: "Input envelope for PostgreSQL adapter operations"
      properties:
        operation_type:
          type: "string"
          enum: ["query", "health_check"]
        query_request:
          $ref: "#/shared_models/ModelPostgresQueryRequest"
        health_request:
          $ref: "#/shared_models/ModelPostgresHealthRequest"
        correlation_id:
          type: "string"
          format: "uuid"
        timestamp:
          type: "number"
        context:
          type: "object"
      required: ["operation_type", "correlation_id", "timestamp"]

    ModelPostgresAdapterOutput:
      type: "object"
      description: "Output envelope for PostgreSQL adapter operations"
      properties:
        operation_type:
          type: "string"
          enum: ["query", "health_check"]
        query_response:
          $ref: "#/shared_models/ModelPostgresQueryResponse"
        health_response:
          $ref: "#/shared_models/ModelPostgresHealthResponse"
        success:
          type: "boolean"
        error_message:
          type: "string"
          nullable: true
        correlation_id:
          type: "string"
          format: "uuid"
        timestamp:
          type: "number"
        execution_time_ms:
          type: "number"
        context:
          type: "object"
      required: ["operation_type", "success", "correlation_id", "timestamp", "execution_time_ms"]

  schemas: {}
  
  responses: {}

# === SHARED MODEL REFERENCES ===
shared_models:
  ModelPostgresQueryRequest:
    module: "omnibase_infra.models.postgres.model_postgres_query_request"
    class_name: "ModelPostgresQueryRequest"
  
  ModelPostgresQueryResponse:
    module: "omnibase_infra.models.postgres.model_postgres_query_response"
    class_name: "ModelPostgresQueryResponse"
  
  ModelPostgresHealthRequest:
    module: "omnibase_infra.models.postgres.model_postgres_health_request"
    class_name: "ModelPostgresHealthRequest"
  
  ModelPostgresHealthResponse:
    module: "omnibase_infra.models.postgres.model_postgres_health_response"
    class_name: "ModelPostgresHealthResponse"