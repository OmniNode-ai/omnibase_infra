# SPDX-License-Identifier: MIT
# Copyright (c) 2025 OmniNode Team
#
# ONEX Node Contract
# Node: NodeRegistrationStorageEffect
#
# Capability-oriented effect node for registration storage operations.
# Named by capability ("registration.storage"), not by vendor (PostgreSQL/MongoDB).
# Principle: "I'm interested in what you do, not what you are"
#
# This contract defines the interface for storage operations with pluggable backends.
# Handlers implementing ProtocolRegistrationStorageHandler can be swapped without
# changing the node interface.
# Contract identifiers
name: "node_registration_storage_effect"
contract_name: "node_registration_storage_effect"
node_name: "node_registration_storage_effect"
# Version (semantic versioning)
version:
  major: 1
  minor: 0
  patch: 0
contract_version:
  major: 1
  minor: 0
  patch: 0
node_version:
  major: 1
  minor: 0
  patch: 0
# Node type
node_type: "EFFECT"
# Description
description: >
  Capability-oriented effect node for registration storage operations. Handles store, query, update, and delete operations for node registrations with pluggable backend handlers (PostgreSQL, MongoDB, etc.).

# Strongly typed I/O models
input_model:
  name: "ModelStorageQuery"
  module: "omnibase_infra.nodes.node_registration_storage_effect.models"
  description: "Input model for storage query operations."
output_model:
  name: "ModelStorageResult"
  module: "omnibase_infra.nodes.node_registration_storage_effect.models"
  description: "Output model containing query results and metadata."
# Capability declaration (capability-oriented naming)
capabilities:
  - name: "registration.storage"
    description: "Store, query, update, and delete node registration records"
    version: "1.0.0"
  - name: "registration.storage.query"
    description: "Query registration records with filtering and pagination"
  - name: "registration.storage.upsert"
    description: "Insert or update registration records idempotently"
  - name: "registration.storage.delete"
    description: "Delete registration records by node ID"
  - name: "registration.storage.health"
    description: "Health check for storage backend connectivity"
# IO operations (EFFECT node specific)
io_operations:
  - operation: "store_registration"
    description: "Store a new registration record or update existing"
    input_fields:
      - record: "ModelRegistrationRecord"
      - correlation_id: "UUID"
    output_fields:
      - result: "ModelUpsertResult"
    idempotent: true
  - operation: "query_registrations"
    description: "Query registration records with optional filters"
    input_fields:
      - query: "ModelStorageQuery"
      - correlation_id: "UUID"
    output_fields:
      - result: "ModelStorageResult"
    idempotent: true
  - operation: "update_registration"
    description: "Update specific fields of a registration record"
    input_fields:
      - node_id: "UUID"
      - updates: "dict[str, object]"
      - correlation_id: "UUID"
    output_fields:
      - result: "ModelUpsertResult"
    idempotent: true
  - operation: "delete_registration"
    description: "Delete a registration record by node ID"
    input_fields:
      - node_id: "UUID"
      - correlation_id: "UUID"
    output_fields:
      - success: "bool"
    idempotent: true
  - operation: "health_check"
    description: "Check storage backend health and connectivity"
    input_fields: []
    output_fields:
      - health: "dict[str, object]"
    idempotent: true
# Dependencies (protocols this node requires)
dependencies:
  - name: "protocol_registration_storage_handler"
    type: "protocol"
    class_name: "ProtocolRegistrationStorageHandler"
    module: "omnibase_infra.nodes.node_registration_storage_effect.protocols"
    description: "Protocol for registration storage backends (PostgreSQL, MongoDB, etc.)"
    pluggable: true
    implementations:
      - name: "postgresql"
        description: "PostgreSQL implementation for registration storage"
      - name: "mongodb"
        description: "MongoDB implementation for registration storage"
# Handler routing (for pluggable backends)
handler_routing:
  routing_strategy: "handler_type_match"
  default_handler: "postgresql"
  handlers:
    - handler_type: "postgresql"
      handler:
        name: "HandlerPostgresRegistrationStorage"
        module: "omnibase_infra.handlers.storage.handler_postgres_registration_storage"
      description: "PostgreSQL storage handler"
    - handler_type: "mongodb"
      handler:
        name: "HandlerMongoRegistrationStorage"
        module: "omnibase_infra.handlers.storage.handler_mongo_registration_storage"
      description: "MongoDB storage handler"
# Error handling configuration
error_handling:
  retry_policy:
    max_retries: 3
    initial_delay_ms: 100
    max_delay_ms: 5000
    exponential_base: 2
    retry_on:
      - "InfraConnectionError"
      - "InfraTimeoutError"
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    reset_timeout_ms: 60000
  error_types:
    - name: "StorageConnectionError"
      description: "Unable to connect to storage backend"
      recoverable: true
      retry_strategy: "exponential_backoff"
    - name: "StorageTimeoutError"
      description: "Storage operation timed out"
      recoverable: true
      retry_strategy: "exponential_backoff"
    - name: "RecordNotFoundError"
      description: "Registration record not found"
      recoverable: false
      retry_strategy: "none"
    - name: "ValidationError"
      description: "Input validation failed"
      recoverable: false
      retry_strategy: "none"
# Health check configuration
health_check:
  enabled: true
  endpoint: "/health"
  interval_seconds: 30
  timeout_ms: 5000
  checks:
    - name: "storage_backend"
      type: "connection"
      critical: true
# Metadata
metadata:
  author: "OmniNode Team"
  license: "MIT"
  created: "2025-01-06"
  tags:
    - effect
    - registration
    - storage
    - capability-oriented
    - pluggable-backend
