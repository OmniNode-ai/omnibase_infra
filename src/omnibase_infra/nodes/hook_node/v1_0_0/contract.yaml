# Hook Node - ONEX Contract
# Effect node for sending webhook notifications via message bus integration

# === REQUIRED ROOT FIELDS ===
contract_version: {major: 1, minor: 0, patch: 0}
node_name: "hook_node"
node_version: {major: 1, minor: 0, patch: 0}
contract_name: "hook_node_contract"
description: "Webhook notification bridge for the ONEX message bus"
node_type: "EFFECT"
name: "hook_node"
version: {major: 1, minor: 0, patch: 0}
input_model: "ModelHookNodeInput"
output_model: "ModelHookNodeOutput"

# === REQUIRED METADATA FIELDS ===
uuid: "a1b2c3d4-e5f6-7890-1234-567890abcdef"
created_at: "2025-09-14T22:00:00Z"
last_modified_at: "2025-09-14T22:00:00Z"
hash: "sha256:hook_node_phase1_implementation"
entrypoint: "omnibase_infra.nodes.hook_node.v1_0_0.node:NodeHookEffect"
namespace: "omnibase_infra.notification"
author: "ONEX"

# === NODE SPECIFICATION ===
node_specification:
  node_name: "hook_node"
  version: {major: 1, minor: 0, patch: 0}
  description: "Webhook notification bridge for the ONEX message bus"
  main_node_class: "NodeHookEffect"
  container_injection: "ONEXContainer"
  business_logic_pattern: "effect"

# === DEPENDENCIES ===
dependencies:
  - name: "protocol_http_client"
    type: "protocol"
    class_name: "ProtocolHttpClient"
    module: "omnibase_spi.protocols.core"
  - name: "protocol_event_bus"
    type: "protocol"
    class_name: "ProtocolEventBus"
    module: "omnibase_spi.protocols.event_bus"

# === SHARED MODEL DEPENDENCIES ===
shared_model_dependencies:
  - name: "model_notification_request"
    type: "model"
    class_name: "ModelNotificationRequest"
    module: "omnibase_infra.models.notification.model_notification_request"
    description: "Shared notification request model"
  - name: "model_notification_result"
    type: "model"
    class_name: "ModelNotificationResult"
    module: "omnibase_infra.models.notification.model_notification_result"
    description: "Shared notification result model"
  - name: "model_notification_auth"
    type: "model"
    class_name: "ModelNotificationAuth"
    module: "omnibase_infra.models.notification.model_notification_auth"
    description: "Shared notification authentication model"
  - name: "model_notification_retry_policy"
    type: "model"
    class_name: "ModelNotificationRetryPolicy"
    module: "omnibase_infra.models.notification.model_notification_retry_policy"
    description: "Shared notification retry policy model"
  - name: "model_notification_attempt"
    type: "model"
    class_name: "ModelNotificationAttempt"
    module: "omnibase_infra.models.notification.model_notification_attempt"
    description: "Shared notification attempt model"

# === EVENT TYPE CONFIGURATION ===
event_type:
  primary_events: ["hook_notification_send"]
  event_categories: ["infrastructure", "notification", "webhook"]
  publish_events: true
  subscribe_events: false
  event_routing: "infrastructure"

# === INPUT/OUTPUT STATE ===
input_state:
  object_type: "object"
  required:
    - "notification_request"
    - "correlation_id"
    - "timestamp"
  properties:
    notification_request:
      property_type: "object"
      description: "Notification request payload"
      reference: "ModelNotificationRequest"
    correlation_id:
      property_type: "string"
      description: "Request correlation ID for tracing"
      format: "uuid"
    timestamp:
      property_type: "number"
      description: "Request timestamp"
    context:
      property_type: "object"
      description: "Additional request context"

output_state:
  object_type: "object"
  properties:
    notification_result:
      property_type: "object"
      description: "Notification result payload"
      reference: "ModelNotificationResult"
    success:
      property_type: "boolean"
      description: "Whether the notification was successfully delivered"
    error_message:
      property_type: "string"
      description: "Error message if operation failed"
    correlation_id:
      property_type: "string"
      description: "Request correlation ID for tracing"
      format: "uuid"
    timestamp:
      property_type: "number"
      description: "Response timestamp"
    total_execution_time_ms:
      property_type: "number"
      description: "Total operation execution time in milliseconds"

# === IO OPERATIONS (Required for EFFECT nodes) ===
io_operations:
  - operation_type: "http_notification_send"
    atomic: true
    backup_enabled: false
    permissions: null
    recursive: false
    buffer_size: 8192
    timeout_seconds: 60
    validation_enabled: true
    description: "Sends a single HTTP-based notification with retry support"

# === CONFIGURATION ===
configuration:
  security:
    max_payload_size_bytes: 1048576  # 1MB (1024 * 1024)
    rate_limit_requests_per_minute: 60
    rate_limit_window_seconds: 60
    ssrf_protection_enabled: true
    url_validation_enabled: true

  circuit_breaker:
    failure_threshold: 5  # Open circuit after 5 failures
    timeout_seconds: 60   # Wait 60 seconds before retry
    half_open_max_calls: 3  # Allow 3 test calls in half-open state
    max_circuit_breakers: 1000  # Maximum number of circuit breakers to store

  http:
    request_timeout_seconds: 30.0  # 30 second timeout for HTTP requests

  retry_policy_defaults:
    max_attempts: 3
    backoff_strategy: "exponential"
    delay_seconds: 5.0
    retryable_status_codes: [408, 429, 500, 502, 503, 504]

# === DEFINITIONS (Required by ModelContractContent) ===
definitions:
  models:
    # --- Input/Output Wrappers ---
    ModelHookNodeInput:
      type: "object"
      description: "Input envelope for the Hook Node."
      properties:
        notification_request:
          $ref: "#/shared_models/ModelNotificationRequest"
        correlation_id:
          type: "string"
          format: "uuid"
        timestamp:
          type: "number"
          description: "Unix timestamp of the request."
        context:
          type: "object"
          description: "Additional request context"
      required: ["notification_request", "correlation_id", "timestamp"]

    ModelHookNodeOutput:
      type: "object"
      description: "Output envelope from the Hook Node."
      properties:
        notification_result:
          $ref: "#/shared_models/ModelNotificationResult"
        success:
          type: "boolean"
          description: "Indicates if the final notification attempt was successful (e.g., 2xx status code)."
        error_message:
          type: "string"
          nullable: true
          description: "Error message if the operation failed completely."
        correlation_id:
          type: "string"
          format: "uuid"
        timestamp:
          type: "number"
          description: "Unix timestamp of the response."
        total_execution_time_ms:
          type: "number"
        context:
          type: "object"
          description: "Additional response context"
      required: ["notification_result", "success", "correlation_id", "timestamp", "total_execution_time_ms"]

    # --- Notification Models (Shared via dependencies) ---
    ModelNotificationRequest:
      type: "object"
      description: "Request to send a webhook notification."
      properties:
        url:
          type: "string"
          format: "uri"
          description: "Target URL for the webhook"
        method:
          $ref: "#/definitions/enums/EnumNotificationMethod"
        headers:
          type: "object"
          additionalProperties:
            type: "string"
          description: "HTTP headers to include with the request"
        payload:
          $ref: "#/definitions/models/ModelWebhookPayloadUnion"
          description: "Strongly-typed webhook payload with agent-safe validation"
        auth:
          $ref: "#/definitions/models/ModelNotificationAuth"
          nullable: true
        retry_policy:
          $ref: "#/definitions/models/ModelNotificationRetryPolicy"
          nullable: true
      required: ["url", "method", "payload"]

    ModelNotificationAuth:
      type: "object"
      description: "Authentication details for the webhook request."
      properties:
        auth_type:
          $ref: "#/definitions/enums/EnumAuthType"
        credentials:
          type: "object"
          description: "Credentials, structure depends on auth_type."
          properties:
            token:
              type: "string"
              x-sensitive: true
              description: "Bearer token for authentication"
            username:
              type: "string"
              description: "Username for basic authentication"
            password:
              type: "string"
              x-sensitive: true
              description: "Password for basic authentication"
            header_name:
              type: "string"
              description: "Custom header name for API key authentication"
            api_key:
              type: "string"
              x-sensitive: true
              description: "API key value"
      required: ["auth_type", "credentials"]

    ModelNotificationRetryPolicy:
      type: "object"
      description: "Policy for retrying failed notification attempts."
      properties:
        max_attempts:
          type: "integer"
          minimum: 1
          maximum: 10
          default: 3
          description: "Maximum number of delivery attempts"
        backoff_strategy:
          $ref: "#/definitions/enums/EnumBackoffStrategy"
          default: "exponential"
        delay_seconds:
          type: "number"
          minimum: 1
          default: 5
          description: "Initial delay between retries in seconds"
        retryable_status_codes:
          type: "array"
          items:
            type: "integer"
          default: [408, 429, 500, 502, 503, 504]
          description: "HTTP status codes that should trigger a retry"
      required: ["max_attempts"]

    ModelNotificationAttempt:
      type: "object"
      description: "Record of a single notification attempt."
      properties:
        attempt_number:
          type: "integer"
          description: "Attempt number (1-based)"
        timestamp:
          type: "number"
          description: "Unix timestamp of the attempt"
        status_code:
          type: "integer"
          nullable: true
          description: "HTTP status code received (null if network error)"
        error:
          type: "string"
          nullable: true
          description: "Error message if the attempt failed"
        execution_time_ms:
          type: "number"
          description: "Time taken for this attempt in milliseconds"
      required: ["attempt_number", "timestamp", "execution_time_ms"]

    ModelNotificationResult:
      type: "object"
      description: "Final result after all notification attempts."
      properties:
        final_status_code:
          type: "integer"
          nullable: true
          description: "Final HTTP status code received"
        is_success:
          type: "boolean"
          description: "Whether the notification was ultimately successful"
        attempts:
          type: "array"
          items:
            $ref: "#/definitions/models/ModelNotificationAttempt"
          description: "List of all delivery attempts made"
        total_attempts:
          type: "integer"
          description: "Total number of attempts made"
      required: ["is_success", "attempts", "total_attempts"]

    # --- Webhook Payload Models (Agent-Safe) ---
    ModelWebhookPayloadUnion:
      oneOf:
        - $ref: "#/definitions/models/ModelSlackWebhookPayload"
        - $ref: "#/definitions/models/ModelDiscordWebhookPayload"
        - $ref: "#/definitions/models/ModelTeamsWebhookPayload"
        - $ref: "#/definitions/models/ModelInfrastructureAlertPayload"
      description: "Union of strongly-typed webhook payloads for agent-safe execution"

    ModelSlackWebhookPayload:
      type: "object"
      description: "Slack-specific webhook payload with strict typing"
      properties:
        webhook_type:
          type: "string"
          enum: ["slack"]
          default: "slack"
        text:
          type: "string"
          description: "Primary message text"
        channel:
          type: "string"
          nullable: true
          description: "Target Slack channel"
        username:
          type: "string"
          nullable: true
          description: "Bot username override"
        icon_emoji:
          type: "string"
          nullable: true
          description: "Bot emoji icon"
      required: ["text"]

    ModelDiscordWebhookPayload:
      type: "object"
      description: "Discord-specific webhook payload with strict typing"
      properties:
        webhook_type:
          type: "string"
          enum: ["discord"]
          default: "discord"
        content:
          type: "string"
          description: "Primary message content"
        username:
          type: "string"
          nullable: true
          description: "Bot username override"
        avatar_url:
          type: "string"
          nullable: true
          description: "Bot avatar URL"
      required: ["content"]

    ModelTeamsWebhookPayload:
      type: "object"
      description: "Microsoft Teams webhook payload with strict typing"
      properties:
        webhook_type:
          type: "string"
          enum: ["teams"]
          default: "teams"
        summary:
          type: "string"
          description: "Message summary"
        text:
          type: "string"
          description: "Message content"
        title:
          type: "string"
          nullable: true
          description: "Message title"
        theme_color:
          type: "string"
          nullable: true
          description: "Theme color (hex)"
      required: ["summary", "text"]

    ModelInfrastructureAlertPayload:
      type: "object"
      description: "Infrastructure alert payload for ONEX systems"
      properties:
        webhook_type:
          type: "string"
          enum: ["infrastructure_alert"]
          default: "infrastructure_alert"
        alert_level:
          type: "string"
          enum: ["info", "warning", "critical"]
          description: "Alert severity level"
        service_name:
          type: "string"
          description: "Service generating the alert"
        alert_message:
          type: "string"
          description: "Primary alert message"
        node_id:
          type: "string"
          nullable: true
          description: "ONEX node identifier"
        correlation_id:
          type: "string"
          nullable: true
          description: "Request correlation ID"
        timestamp:
          type: "string"
          format: "date-time"
          nullable: true
          description: "Alert timestamp"
      required: ["alert_level", "service_name", "alert_message"]

  enums:
    EnumNotificationMethod:
      type: "string"
      enum: ["POST", "PUT"]
      description: "Supported HTTP methods for notifications"

    EnumAuthType:
      type: "string"
      enum: ["bearer", "basic", "api_key_header"]
      description: "Supported authentication types"

    EnumBackoffStrategy:
      type: "string"
      enum: ["exponential", "linear", "fixed"]
      description: "Retry backoff strategies"

  schemas: {}
  responses: {}

# === SHARED MODEL REFERENCES ===
shared_models:
  ModelNotificationRequest:
    module: "omnibase_infra.models.notification.model_notification_request"
    class_name: "ModelNotificationRequest"
  ModelNotificationResult:
    module: "omnibase_infra.models.notification.model_notification_result"
    class_name: "ModelNotificationResult"
  ModelNotificationAuth:
    module: "omnibase_infra.models.notification.model_notification_auth"
    class_name: "ModelNotificationAuth"
  ModelNotificationRetryPolicy:
    module: "omnibase_infra.models.notification.model_notification_retry_policy"
    class_name: "ModelNotificationRetryPolicy"
  ModelNotificationAttempt:
    module: "omnibase_infra.models.notification.model_notification_attempt"
    class_name: "ModelNotificationAttempt"